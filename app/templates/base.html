<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>{% block title %}Node Tool{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    {% block styles %}{% endblock %}
    
    <style>
        /* =========================================
           1. æ ¸å¿ƒ CSS å˜é‡ä¸åŠ¨ç”»è®¾ç½®
           ========================================= */
        :root {
            --sidebar-width-expanded: 240px;
            --sidebar-width-collapsed: 64px;
            --transition-curve: cubic-bezier(0.2, 0.8, 0.2, 1); 
            --transition-duration: 0.5s;
        }

        /* åˆå§‹åŠ è½½æ—¶ç¦æ­¢åŠ¨ç”»ï¼Œé˜²æ­¢é—ªçƒ */
        body.no-transition * {
            transition: none !important;
        }

        /* ä¾§è¾¹æ å®¹å™¨ */
        .sidebar {
            background: #ffffff;
            border-right: 1px solid #eef1f5;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.03); 
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            z-index: 1000;
            width: var(--sidebar-width-expanded);
            transition: width var(--transition-duration) var(--transition-curve);
            will-change: width;
            white-space: nowrap;
            overflow: hidden; 
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        .sidebar-header {
            height: 70px;
            padding: 0 22px; 
            display: flex;
            align-items: center;
            justify-content: flex-start; 
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            transition: padding var(--transition-duration) var(--transition-curve), justify-content var(--transition-duration) step-end; 
            z-index: 10;
        }
        
        body:not(.sidebar-collapsed) .sidebar-header {
            margin-bottom: 10px; 
        }

        /* Logo å®¹å™¨ */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%; 
            overflow: hidden;
            transition: justify-content var(--transition-duration) var(--transition-curve);
        }

        /* Logo å›¾æ ‡ */
        .logo-icon {
            width: 30px; 
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
            z-index: 2;
        }

        .logo-icon svg {
            width: 100%;
            height: 100%;
            display: block; 
        }

        /* Logo æ–‡å­— */
        .logo-text {
            font-size: 19px;
            font-weight: 800;
            color: #1a202c;
            font-family: 'Segoe UI', system-ui, sans-serif;
            opacity: 1;
            transform: translateX(0);
            /* å±•å¼€æ—¶ï¼šå»¶è¿Ÿæ˜¾ç¤ºï¼Œæ˜¾å¾—ä¼˜é›… */
            transition: opacity 0.3s ease-out 0.15s, transform 0.3s var(--transition-curve) 0.15s;
        }

        /* åˆ‡æ¢æŒ‰é’® */
        .toggle-btn {
            position: absolute;
            right: 18px;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background-color: transparent;
            border: 1px solid transparent;
            color: #94a3b8;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .toggle-btn:hover {
            background-color: #f1f5f9;
            color: #007aff;
        }

        /* å¯¼èˆªèœå• */
        .sidebar-nav {
            flex-grow: 1;
            overflow-x: hidden;
            overflow-y: auto;
            padding: 0 12px;
            transition: padding var(--transition-duration) var(--transition-curve);
            position: relative; 
            z-index: 20; 
        }

        .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav li { margin-bottom: 4px; }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 10px;
            color: #64748b;
            text-decoration: none;
            transition: all 0.2s ease, padding var(--transition-duration) var(--transition-curve);
            height: 44px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            z-index: 20;
        }

        .nav-link:hover {
            background-color: #f8fafc;
            color: #007aff;
        }

        .nav-link.active {
            background-color: #eff6ff;
            color: #007aff;
            font-weight: 600;
        }

        .nav-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            flex-shrink: 0; 
            margin-right: 12px;
            transition: margin 0.4s var(--transition-curve);
        }

        .nav-text {
            white-space: nowrap;
            opacity: 1;
            /* å±•å¼€æ—¶ï¼šå»¶è¿Ÿæ˜¾ç¤º */
            transition: opacity 0.2s ease-out 0.1s, transform 0.4s var(--transition-curve);
        }

        /* åº•éƒ¨ Footer */
        .sidebar-footer {
            padding: 15px;
            flex-shrink: 0;
            border-top: 1px solid #f1f5f9;
            margin-top: auto;
            overflow: hidden;
            transition: padding var(--transition-duration) var(--transition-curve);
            position: relative; 
            z-index: 20;
        }
        
        .logout-link {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 10px;
            color: #64748b;
            text-decoration: none;
            transition: background 0.2s, padding var(--transition-duration) var(--transition-curve);
            height: 44px;
            box-sizing: border-box;
            z-index: 20;
        }
        
        .logout-link:hover {
            background-color: #fff1f2;
            color: #e11d48;
        }

        /* =========================================
           2. æŠ˜å çŠ¶æ€é€»è¾‘ (Collapsed State) - å…³é”®ä¿®å¤åŒº
           ========================================= */
        body.sidebar-collapsed .sidebar {
            width: var(--sidebar-width-collapsed);
        }

        /* Header å±…ä¸­ */
        body.sidebar-collapsed .sidebar-header {
            padding: 0; 
            justify-content: center; 
            cursor: pointer;
        }
        
        body.sidebar-collapsed .sidebar-header:hover .logo-icon {
            transform: scale(1.1); 
        }
        
        body.sidebar-collapsed .logo-container {
            justify-content: center;
            width: 100%;
            gap: 0;
        }

        /* ğŸš¨ ä¿®å¤ 1ï¼šLogo æ–‡å­—åœ¨æŠ˜å æ—¶ç«‹å³æ¶ˆå¤± */
        body.sidebar-collapsed .logo-text {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            /* å…³é”®ï¼š0ç§’å»¶è¿Ÿï¼Œç¬é—´éšè— */
            transition: opacity 0s linear; 
        }

        /* ğŸš¨ ä¿®å¤ 2ï¼šå¯¼èˆªæ–‡å­—åœ¨æŠ˜å æ—¶ç«‹å³æ¶ˆå¤± */
        body.sidebar-collapsed .nav-text {
            opacity: 0;
            position: absolute;
            left: 40px; /* ç§»å‡ºå¯è§†åŒºåŸŸä»¥é˜²ä¸‡ä¸€ */
            pointer-events: none;
            /* å…³é”®ï¼š0ç§’å»¶è¿Ÿï¼Œç¬é—´éšè— */
            transition: opacity 0s linear; 
        }

        /* åˆ‡æ¢æŒ‰é’®ç«‹å³æ¶ˆå¤± */
        body.sidebar-collapsed .toggle-btn {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            transition: opacity 0s linear;
        }
        
        /* å¯¼èˆªå®¹å™¨è°ƒæ•´ */
        body.sidebar-collapsed .sidebar-nav {
            padding: 0 10px; 
        }

        body.sidebar-collapsed .nav-link, 
        body.sidebar-collapsed .logout-link {
            padding: 10px 0; 
            justify-content: center; 
        }

        body.sidebar-collapsed .nav-icon {
            margin-right: 0;
        }
        
        body.sidebar-collapsed .sidebar-footer {
            padding: 15px 10px;
        }

        /* å†…å®¹åŒºè‡ªé€‚åº” */
        .main-content {
            transition: margin-left var(--transition-duration) var(--transition-curve);
        }
    </style>
</head>
<body>
    <script>
        (function() {
            var isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
            if (isCollapsed) {
                document.body.classList.add('sidebar-collapsed');
            }
            document.body.classList.add('no-transition');
        })();
    </script>

    <div class="app-wrapper" id="appWrapper">
        
        {% if request.endpoint != 'auth.login' %}
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header" id="sidebarHeader">
                <div class="logo-container">
                    <div class="logo-icon">
                        <svg class="icon" viewBox="0 0 1051 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">
                            <path d="M727.204278 714.609626m-135.255615 0a135.255615 135.255615 0 1 0 270.51123 0 135.255615 135.255615 0 1 0-270.51123 0Z" fill="#cdcdcd" class="selected"></path>
                            <path d="M779.225668 492.834225h-163.730481c-50.37861 0-91.995722-41.069519-91.995722-91.995722V237.655615c0-50.37861 41.069519-91.995722 91.995722-91.995722h163.730481c50.37861 0 91.995722 41.069519 91.995722 91.995722v163.730481c-0.547594 50.37861-41.617112 91.448128-91.995722 91.448129z m-163.730481-300.081284c-24.641711 0-44.902674 20.260963-44.902674 44.902674v163.730481c0 24.641711 20.260963 44.902674 44.902674 44.902674h163.730481c24.641711 0 44.902674-20.260963 44.902674-44.902674V237.655615c0-24.641711-20.260963-44.902674-44.902674-44.902674h-163.730481zM398.100535 867.935829H234.370053c-50.37861 0-91.995722-41.069519-91.995721-91.995722v-163.730481c0-50.37861 41.069519-91.995722 91.995721-91.995722h163.730482c50.37861 0 91.995722 41.069519 91.995722 91.995722v163.730481c0 50.926203-41.069519 91.995722-91.995722 91.995722z m-163.730482-300.628877c-24.641711 0-44.902674 20.260963-44.902673 44.902674v163.730481c0 24.641711 20.260963 44.902674 44.902673 44.902674h163.730482c24.641711 0 44.902674-20.260963 44.902674-44.902674v-163.730481c0-24.641711-20.260963-44.902674-44.902674-44.902674H234.370053zM779.225668 867.935829h-163.730481c-50.37861 0-91.995722-41.069519-91.995722-91.995722v-163.730481c0-50.37861 41.069519-91.995722 91.995722-91.995722h163.730481c50.37861 0 91.995722 41.069519 91.995722 91.995722v163.730481c-0.547594 50.926203-41.617112 91.995722-91.995722 91.995722z m-163.730481-300.628877c-24.641711 0-44.902674 20.260963-44.902674 44.902674v163.730481c0 24.641711 20.260963 44.902674 44.902674 44.902674h163.730481c24.641711 0 44.902674-20.260963 44.902674-44.902674v-163.730481c0-24.641711-20.260963-44.902674-44.902674-44.902674h-163.730481zM278.17754 342.793583H205.347594c-13.142246 0-23.546524-10.404278-23.546524-23.546524s10.404278-23.546524 23.546524-23.546524h72.829946c13.142246 0 23.546524 10.404278 23.546524 23.546524zM427.670588 342.793583H354.840642c-13.142246 0-23.546524-10.404278-23.546524-23.546524s10.404278-23.546524 23.546524-23.546524h72.829946c13.142246 0 23.546524 10.404278 23.546524 23.546524s-10.951872 23.546524-23.546524 23.546524z" fill="#1296db" class=""></path>
                        </svg>
                    </div>
                    <span class="logo-text" style="margin-left: 10px;">Node Tool</span>
                </div>
                
                <button id="toggleSidebar" class="toggle-btn" title="æŠ˜å /å±•å¼€èœå•">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="3" x2="9" y2="21"></line>
                    </svg>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="{{ url_for('dashboard.index') }}" class="nav-link {% if request.endpoint and 'dashboard' in request.endpoint %}active{% endif %}">
                            <div class="nav-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                                    <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                                    <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                                    <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                                </svg>
                            </div>
                            <span class="nav-text">ä»ªè¡¨ç›˜</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('subscription.manager') }}" class="nav-link {% if request.endpoint and 'subscription' in request.endpoint %}active{% endif %}">
                            <div class="nav-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </div>
                            <span class="nav-text">è®¢é˜…ç®¡ç†</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('history.view_history') }}" class="nav-link {% if request.endpoint and 'history' in request.endpoint %}active{% endif %}">
                            <div class="nav-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                            <span class="nav-text">æµé‡å†å²</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('settings.general_settings') }}" class="nav-link {% if request.endpoint and 'settings' in request.endpoint %}active{% endif %}">
                            <div class="nav-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                </svg>
                            </div>
                            <span class="nav-text">ç³»ç»Ÿè®¾ç½®</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <a href="{{ url_for('auth.logout') }}" class="logout-link" title="å®‰å…¨é€€å‡º">
                     <div class="nav-icon" style="color: #ff4d4f;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                     </div>
                    <span class="nav-text">é€€å‡ºç™»å½•</span>
                </a>
            </div>
        </aside>
        {% endif %}

        <main class="main-content d-flex flex-column {% if request.endpoint == 'auth.login' %}full-width{% endif %}" 
              style="min-height: 100vh; display: flex; flex-direction: column;">
             
             <div class="flash-messages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert {{ category }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <div class="flex-grow-1" style="flex: 1;">
                {% block content %}{% endblock %}
            </div>

            {% if request.endpoint != 'auth.login' %}
            <footer class="main-footer">
                <p>Node Tool v1 &copy; 2025</p>
            </footer>
            {% endif %}
        </main>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block scripts %}{% endblock %}

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåçš„é€»è¾‘
        window.addEventListener('load', function() {
            setTimeout(function() {
                // ç§»é™¤ç¦æ­¢åŠ¨ç”»ç±»ï¼Œæ¢å¤è¿‡æ¸¡æ•ˆæœ
                document.body.classList.remove('no-transition');
            }, 100);
        });
        
        // è·å–å…ƒç´ 
        const toggleBtn = document.getElementById('toggleSidebar');
        const sidebarHeader = document.getElementById('sidebarHeader'); 
        
        // 1. åˆ‡æ¢æŒ‰é’®é€»è¾‘
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function(e) {
                e.stopPropagation(); 
                document.body.classList.toggle('sidebar-collapsed');
                const isCollapsed = document.body.classList.contains('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', isCollapsed);
            });
        }
        
        // 2. å¤´éƒ¨ç‚¹å‡»é€»è¾‘ï¼ˆä»…ç”¨äºå±•å¼€ï¼‰
        if (sidebarHeader) {
            sidebarHeader.addEventListener('click', function() {
                if (document.body.classList.contains('sidebar-collapsed')) {
                    document.body.classList.remove('sidebar-collapsed');
                    localStorage.setItem('sidebar-collapsed', 'false');
                }
            });
        }
    </script>
</body>
</html>