{% extends 'base.html' %}

{% block title %}è®¢é˜…ç®¡ç† - Node Tool{% endblock %}

{% block styles %}
<style>
    .container-fluid {
        padding: 20px;
    }

    /* =========================================
       1. æ ‡é¢˜æ æ ·å¼ (å¤ç”¨ä»ªè¡¨ç›˜é£æ ¼ - 50px)
       ========================================= */
    .dashboard-title-card {
        height: 55px;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        
        /* è§†è§‰ç¾åŒ– */
        background: linear-gradient(to right, #ffffff, #f4f9ff);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03); 
        border: 1px solid #eef1f5;
        
        margin-bottom: 25px;
        box-sizing: border-box;
        position: relative; 
        overflow: hidden;
    }

    .dashboard-title-card h2 {
        margin: 0;
        font-size: 21px;
        font-weight: 700;
        color: #333;
        letter-spacing: 1px;
        z-index: 2; 
        font-family: 'Segoe UI', system-ui, sans-serif;
    }

    /* èƒŒæ™¯æ°´å°è£…é¥° */
    .dashboard-title-card::after {
        content: 'ğŸ—‚ï¸'; 
        position: absolute;
        right: 30px;
        bottom: -25px;
        font-size: 60px;
        opacity: 0.08; 
        transform: rotate(-15deg);
        z-index: 1;
        pointer-events: none; 
        filter: grayscale(100%);
    }

    /* =========================================
       2. ç½‘æ ¼å¸ƒå±€ä¸å¡ç‰‡
       ========================================= */
    .top-section-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
    }
    
    .subscription-list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .sub-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid #eee;
        height: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
    }

    .sub-card-compact {
        background: white;
        border-radius: 10px;
        padding: 15px 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        border: 1px solid #eee;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .sub-card-expanded {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        border: 1px solid #eee;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f5f5f7;
    }
    
    .sub-card-compact .card-header, 
    .sub-card-expanded .card-header {
        border-bottom: none;
        margin-bottom: 5px;
        padding-bottom: 0;
    }
    
    .sub-card-expanded .card-header {
        margin-bottom: 10px;
    }

    .card-title {
        font-size: 16px;
        font-weight: 700;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .card-desc-compact { 
        font-size: 12px; 
        color: #888; 
        margin: 0; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
    }

    /* =========================================
       3. ç»Ÿè®¡å±•ç¤ºä¸æ ‡ç­¾ (ä¿®æ”¹å¤„ï¼šæ·»åŠ  text-red)
       ========================================= */
    .stats-grid {
        display: grid;
        /* ğŸš¨ ä¿®æ”¹ï¼šä» 3 åˆ—æ”¹ä¸º 4 åˆ—ï¼Œä»¥å®¹çº³æ–°å¢çš„â€œå±è”½èŠ‚ç‚¹â€ */
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .stat-num {
        font-size: 32px;
        font-weight: 700;
        line-height: 1.2;
        transition: opacity 0.2s;
    }
    
    .stat-label {
        font-size: 12px;
        color: #888;
        margin-top: 5px;
    }

    .text-blue { color: #007aff; }
    .text-green { color: #34c759; }
    .text-yellow { color: #f5a623; }
    /* ğŸš¨ æ–°å¢ï¼šçº¢è‰²å­—ä½“æ ·å¼ */
    .text-red { color: #d74242; }

    .protocol-tags { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 8px; 
        justify-content: center; 
        transition: opacity 0.2s; 
        margin-top: auto; 
        overflow: visible;
    }
    
    .proto-tag {
        display: flex;
        align-items: center;
        padding: 4px 10px;
        background: #f5f5f7;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        color: #555;
        border: 1px solid #eee;
    }
    
    .proto-name { margin-right: 6px; }
    .proto-count { background: #fff; padding: 1px 5px; border-radius: 4px; font-weight: 700; color: #333; }

    /* =========================================
       4. è§„åˆ™ç¼–è¾‘ä¸æ“ä½œæŒ‰é’®
       ========================================= */
    .rule-actions { 
        display: grid; 
        grid-template-columns: repeat(2, 1fr);
        gap: 12px; 
        flex: 1; 
        align-items: center; 
        justify-content: center; 
    }
    
    @media (min-width: 768px) {
        .rule-actions {
            display: flex;
            gap: 15px;
        }
    }

    .btn-edit-rule {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1; 
        min-width: 80px; 
        height: 80px;
        border: 1px solid #e1e1e8;
        border-radius: 10px;
        background: #f9f9fc;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        color: #555;
    }
    
    .btn-edit-rule:hover {
        border-color: #007aff;
        background: #f0f7ff;
        color: #007aff;
        transform: translateY(-2px);
    }
    
    .rule-icon { font-size: 20px; margin-bottom: 5px; }
    .rule-name { font-size: 12px; font-weight: 600; text-align: center; line-height: 1.3;}

    /* ğŸš¨ è®¢é˜…é“¾æ¥æ ·å¼ (ç‚¹å‡»å³å¤åˆ¶ä¼˜åŒ–) */
    .sub-link-row {
        display: flex;
        gap: 10px;
        align-items: center;
        width: 100%;
    }
    
    .link-input {
        flex: 1; 
        padding: 8px 12px; 
        border: 1px solid #ddd; 
        border-radius: 6px;
        background: #f9f9fc; /* é»˜è®¤ç¨å¾®ç°ä¸€ç‚¹ï¼Œè¡¨ç¤ºåªè¯» */
        color: #555; 
        font-family: monospace; 
        font-size: 13px;
        outline: none; 
        height: 40px; /* å¢åŠ ä¸€ç‚¹é«˜åº¦æ–¹ä¾¿ç‚¹å‡» */
        box-sizing: border-box;
        cursor: pointer; /* ğŸš¨ é¼ æ ‡å˜æˆæ‰‹å‹ */
        transition: all 0.2s ease;
        text-align: left;
    }
    
    /* ğŸš¨ æ‚¬åœæ•ˆæœï¼šå˜è“ï¼Œæç¤ºå¯äº¤äº’ */
    .link-input:hover {
        border-color: #007aff;
        background: #eef6ff;
        color: #007aff;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    /* ç‚¹å‡»æ•ˆæœ */
    .link-input:active {
        transform: scale(0.99);
    }

    /* æŒ‰é’®ç»„é¢œè‰²åŒºåˆ† */
    .btn-custom-common {
        height: 30px; 
        font-size: 13px;
        padding: 0 14px; 
        color: white;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    }

    /* ç´«è‰²ï¼šè®¢é˜…è®¾ç½® */
    .btn-color-purple { background-color: #6c5ce7; }
    .btn-color-purple:hover { background-color: #5a4bcf; }
    
    /* è“è‰²ï¼šèŠ‚ç‚¹ç®¡ç† */
    .btn-color-blue { background-color: #007aff; }
    .btn-color-blue:hover { background-color: #0062cc; }

    /* æ©™è‰²ï¼šåˆ·æ–°ç¼“å­˜ */
    .btn-color-orange { background-color: #f5a623; }
    .btn-color-orange:hover { background-color: #d48e1b; }
    .btn-color-orange:disabled { background-color: #ccc; cursor: not-allowed; }

    /* =========================================
       5. åè®®é€‰æ‹©å™¨
       ========================================= */
    .protocol-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        padding: 10px 15px;
        background-color: #f9f9fc;
        border-radius: 8px;
        border: 1px solid #eee;
        align-items: center; 
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #555;
        cursor: pointer;
        user-select: none;
    }
    
    .checkbox-label input[type="checkbox"] {
        accent-color: #6c5ce7;
        width: 16px;
        height: 16px;
        cursor: pointer;
    }

    /* =========================================
       6. æ¨¡æ€æ¡†ä¸Toast
       ========================================= */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(3px);
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .modal-overlay.active {
        display: flex;
        opacity: 1;
    }
    
    .editor-box {
        background: white;
        width: 700px;
        height: 80vh;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        padding: 20px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        transform: scale(0.95);
        transition: transform 0.3s, width 0.3s;
    }
    
    .modal-overlay.active .editor-box {
        transform: scale(1);
    }
    
    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .editor-title { font-size: 18px; font-weight: 700; }
    
    .editor-textarea {
        flex: 1;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 14px;
        line-height: 1.5;
        color: #333;
        background: #fafafa;
        resize: none;
        outline: none;
        box-sizing: border-box;
    }
    
    .editor-textarea:focus { border-color: #007aff; background: white; }
    
    .editor-footer { margin-top: 15px; text-align: right; }
    
    .btn-save {
        background: #007aff;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }
    
    .btn-save:hover { background: #0062cc; }

    /* =========================================
       7. èŠ‚ç‚¹ç®¡ç†æ¨¡æ€æ¡†ä¸“å±æ ·å¼
       ========================================= */
    #nodeManagerModal .editor-box {
        width: 1300px; 
        max-width: 95%;
    }
    
    #nodeManagerModal .editor-box.details-open {
        width: 1580px; 
        max-width: 95%;
    }

    .node-manager-container {
        display: grid;
        grid-template-columns: 1.2fr 1.2fr 1.2fr 280px 0;
        gap: 15px;
        flex: 1;
        overflow: hidden;
        height: 100%;
        transition: grid-template-columns 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .node-manager-container.details-open {
        grid-template-columns: 1.2fr 1.2fr 1.2fr 280px 280px;
    }

    .node-column {
        display: flex;
        flex-direction: column;
        background: #f9f9fc;
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 10px;
        min-width: 0;
        min-height: 0;
        height: 100%;
        box-sizing: border-box;
        position: relative;
        overflow: hidden; 
    }

    #col-add {
        overflow: hidden;
    }

    #col-add .add-form {
        overflow-y: auto;
        padding-right: 6px;
    }

    #col-add .add-form::-webkit-scrollbar {
        width: 6px;
    }

    #col-add .add-form::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }
    
    .node-column::before {
        content: attr(data-title);
        display: block;
        text-align: center;
        font-size: 14px;
        font-weight: 700;
        color: #555;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid #ddd;
        white-space: nowrap;
    }
    
    #col-direct::before { border-color: #34c759; color: #34c759; }
    #col-land::before { border-color: #f5a623; color: #f5a623; }
    #col-blocked::before { border-color: #d74242; color: #d74242; }
    #col-add::before { border-color: #007aff; color: #007aff; }
    #col-details::before { border-color: #6c5ce7; color: #6c5ce7; }

    #col-details {
        background: white; 
        border-color: #e0e0e0;
        opacity: 0; 
        transform: translateX(20px);
        transition: opacity 0.2s, transform 0.2s;
        padding: 0; 
        display: flex;
        flex-direction: column !important;
        justify-content: flex-start;
        overflow: hidden;
    }
    
    #detailsContent {
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }

    .node-manager-container.details-open #col-details {
        opacity: 1;
        transform: translateX(0);
        box-shadow: -5px 0 15px rgba(0,0,0,0.03); 
        z-index: 5;
    }
    
    #col-details::before { margin: 10px 10px 0 10px; }

    .details-scroll-area {
        flex: 1; 
        overflow-y: auto; 
        padding: 10px 10px 0 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 0;
    }

    .details-bottom-fixed {
        flex-shrink: 0; 
        padding: 10px;
        background: white;
        border-top: 1px solid #eee;
        z-index: 10;
        width: 100%;
        box-sizing: border-box;
    }

    .details-action-buttons {
        display: flex;
        gap: 10px;
        width: 100%;
    }
    
    .btn-action-panel {
        flex: 1;
        padding: 10px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: background 0.2s;
        white-space: nowrap;
    }

    .btn-close-panel { background: #f0f0f5; color: #333; border: 1px solid #ddd; }
    .btn-close-panel:hover { background: #e5e5ea; }
    .btn-delete-panel { background: #ff3b30; color: white; }
    .btn-delete-panel:hover { background: #d32f2f; }
    .btn-save-panel { background: #34c759; color: white; }
    .btn-save-panel:hover { background: #28a745; }

    .details-node-uuid { display: none !important; }

    .detail-info-group {
        background: #f5f5f7;
        padding: 6px 10px; 
        border-radius: 8px;
        flex-shrink: 0; 
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 36px;
        box-sizing: border-box;
    }

    .details-name-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        height: 100%;
    }
    
    .details-name-input {
        flex: 1;
        font-size: 16px; 
        font-weight: 700; 
        color: #333;
        padding: 0 !important; 
        margin: 0 !important; 
        border: none !important; 
        border-radius: 0 !important;
        background: transparent !important;
        background-color: transparent !important;
        box-shadow: none !important;
        outline: none !important;
        -webkit-appearance: none;
        appearance: none;
        transition: none; 
        margin-right: 10px !important;
        cursor: pointer; 
        width: 100%;
        text-overflow: ellipsis;
        line-height: normal; 
    }
    
    .details-name-input:hover,
    .details-name-input:focus,
    .details-name-input:active {
        background: transparent !important;
        background-color: transparent !important;
        border: none !important;
        box-shadow: none !important; 
        outline: none !important;
    }

    .details-name-input:focus { cursor: text; }

    .node-list {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding-bottom: 10px;
    }

    .node-list::-webkit-scrollbar,
    .editor-textarea::-webkit-scrollbar,
    .details-scroll-area::-webkit-scrollbar {
        width: 6px;
    }
    .node-list::-webkit-scrollbar-thumb,
    .editor-textarea::-webkit-scrollbar-thumb,
    .details-scroll-area::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }
    .node-list::-webkit-scrollbar-thumb:hover,
    .editor-textarea::-webkit-scrollbar-thumb:hover,
    .details-scroll-area::-webkit-scrollbar-thumb:hover {
        background: #aaa;
    }

    .node-item {
        background: white;
        border-radius: 6px;
        border: 1px solid #eee;
        font-size: 12px;
        cursor: grab;
        transition: all 0.2s;
        padding: 8px 10px;
        user-select: none;
    }
    
    .node-item:active { cursor: grabbing; }

    .node-item.dragging { opacity: 0.5; border: 2px dashed #007aff; background: #f0f7ff; }
    .node-item.selected { background: #e6f2ff; border-color: #007aff; box-shadow: 0 0 0 1px #007aff inset; }
    .node-item:hover { border-color: #007aff; background: #f0f7ff; }
    
    .node-content-block { display: flex; flex-direction: column; gap: 4px; pointer-events: none; }
    .node-top-row { display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 5px; }
    .node-name-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; flex: 1; }
    
    .protocol-badges { display: flex; flex-wrap: wrap; gap: 3px; }
    .proto-badge { font-size: 9px; padding: 1px 4px; border-radius: 3px; border: 1px solid transparent; white-space: nowrap; font-weight: 500; }
    
    .proto-badge.hy2, .proto-badge.hysteria2 { background: #fff3e0; color: #fb8c00; border-color: #ffe0b2; }
    .proto-badge.vless { background: #e3f2fd; color: #1e88e5; border-color: #bbdefb; }
    .proto-badge.vmess { background: #fce4ec; color: #d81b60; border-color: #f8bbd0; }
    .proto-badge.trojan { background: #f3e5f5; color: #8e24aa; border-color: #e1bee7; }
    .proto-badge.ss, .proto-badge.shadowsocks { background: #e8f5e9; color: #43a047; border-color: #c8e6c9; }
    .proto-badge.tuic { background: #e0f7fa; color: #00acc1; border-color: #b2ebf2; }
    .proto-badge.socks5 { background: #eceff1; color: #607d8b; border-color: #cfd8dc; }
    .proto-badge.other { background: #f5f5f5; color: #616161; border-color: #eeeeee; }
    
    .db-badge { font-size: 9px; background: #eee; color: #666; padding: 1px 4px; border-radius: 3px; font-weight: 700; margin-left: 5px; }
    .loc-badge { font-size: 9px; background: #e3f2fd; color: #1976d2; padding: 1px 4px; border-radius: 3px; font-weight: 700; margin-left: 5px; }
    .sub-badge { font-size: 9px; background: #f3e5f5; color: #8e24aa; padding: 1px 4px; border-radius: 3px; font-weight: 700; margin-left: 5px; }

    .add-form { display: flex; flex-direction: column; gap: 0px; z-index: 1; height: 100%; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-label { font-size: 12px; font-weight: 600; color: #555; }
    .add-input, .add-select { border: 1px solid #ddd; border-radius: 6px; padding: 8px; font-size: 13px; outline: none; width: 100%; box-sizing: border-box; background: white; }
    .add-input:focus, .add-select:focus { border-color: #007aff; }
    .add-select { cursor: pointer; color: #333; }
    
    .btn-add-large {
        background: #007aff;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        width: 100%;
        font-weight: 600;
        transition: background 0.2s;
    }
    .btn-add-large:hover { background: #0062cc; }

    .add-btn-row {
        display: flex;
        gap: 10px;
        margin-top: auto;
        width: 100%;
        padding-top: 10px;
    }

    .sub-url-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 240px;
        overflow-y: auto;
        padding-right: 4px;
    }

    .sub-entry-card {
        border: 1px solid #e5e5ea;
        border-radius: 10px;
        padding: 12px;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .sub-entry-top {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
    }

    .sub-entry-alias {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 13px;
    }

    .sub-entry-url,
    .sub-entry-note {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 13px;
        box-sizing: border-box;
    }

    .sub-entry-note {
        min-height: 40px;
        resize: vertical;
    }

    .sub-entry-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .btn-entry-action {
        border: 1px solid #ddd;
        background: #f7f7fb;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 12px;
        cursor: pointer;
    }

    .btn-entry-action:hover {
        background: #e8f0ff;
        border-color: #b3ceff;
    }

    .sub-entry-meta {
        font-size: 12px;
        color: #666;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
    }

    .auto-sync-row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .auto-sync-hint {
        font-size: 12px;
        color: #666;
        margin: 6px 0 0 0;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 24px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .2s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .2s;
        border-radius: 50%;
    }

    .switch input:checked + .slider {
        background-color: #34c759;
    }

    .switch input:checked + .slider:before {
        transform: translateX(22px);
    }

    .status-pill {
        padding: 2px 8px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 11px;
    }

    .status-success { background: #e8f5e9; color: #2e7d32; }
    .status-error { background: #ffebee; color: #c62828; }
    .status-warning { background: #fff8e1; color: #f9a825; }
    .status-empty { background: #eceff1; color: #546e7a; }
    .status-pending { background: #e3f2fd; color: #1565c0; }

    .sub-url-empty {
        font-size: 12px;
        color: #999;
        background: #f9f9fc;
        border: 1px dashed #ddd;
        border-radius: 6px;
        padding: 10px;
        text-align: center;
    }

    .sub-report-panel {
        border: 1px solid #e5e5ea;
        border-radius: 10px;
        padding: 12px;
        background: #fff;
        margin-top: 10px;
    }

    .sub-report-meta {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
    }

    .sub-report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .sub-report-body details {
        border: 1px solid #f0f0f5;
        border-radius: 8px;
        padding: 8px 12px;
        margin-bottom: 6px;
    }

    .sub-report-body summary {
        cursor: pointer;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }

    .detail-row { margin-bottom: 0px; display: flex; flex-direction: column; gap: 4px; border-bottom: 1px solid #e1e1e1; padding-bottom: 8px; }
    .detail-row:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
    .detail-top { display: flex; justify-content: space-between; align-items: center; }
    .detail-proto-name { font-weight: 700; color: #333; font-size: 13px; }
    .detail-link-box { position: relative; }
    .detail-link { font-family: monospace; font-size: 11px; color: #555; background: white; border: 1px solid #ddd; padding: 6px; border-radius: 4px; word-break: break-all; }
    
    .btn-details-copy { position: absolute; right: 2px; top: 2px; font-size: 10px; padding: 2px 6px; background: #eee; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; color: #333; }
    .btn-details-copy:hover { background: #e0e0e0; }
    
    .btn-del-proto { font-size: 10px; color: #e74c3c; border: 1px solid #e74c3c; background: white; border-radius: 4px; padding: 1px 8px; cursor: pointer; }
    .btn-del-proto:hover { background: #e74c3c; color: white; }

    .modal-footer-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
    
    .btn-close-modal { background: #f5f5f7; color: #333; border: 1px solid #ddd; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn-close-modal:hover { background: #e5e5e7; }

    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    
    .btn-mini { padding: 4px 10px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; font-weight: 500; transition: background-color 0.2s; }
    .btn-mini-blue { background-color: #007aff; color: white; }
    .btn-mini-blue:hover { background-color: #0062cc; }
    .btn-mini-gray { background-color: #f0f0f5; color: #333; border: 1px solid #ddd; }
    .btn-mini-gray:hover { background-color: #e5e5ea; }
    .btn-mini-green { background-color: #34c759; color: white; }
    .btn-mini-green:hover { background-color: #28a745; }

    .flash-messages { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .alert { padding: 12px 20px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 14px; font-weight: 500; }
    .alert.success { border-left: 4px solid #34c759; color: #333; }
    .alert.error { border-left: 4px solid #d74242; color: #333; }
    .fade-out { opacity: 0; transform: translateY(-20px); transition: all 0.3s; }

</style>
{% endblock %}

{% block content %}
<div class="flash-messages"></div>
<div class="container-fluid">
    
    <div class="dashboard-title-card">
        <h2>è®¢é˜…ç®¡ç†</h2>
    </div>
    
    <div class="top-section-grid">
        
        <div class="sub-card">
            <div class="card-header">
                <span class="card-title">ğŸ“Š èŠ‚ç‚¹æ¦‚è§ˆ</span>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-num text-blue" id="totalCountDisplay">{{ stats.total }}</div>
                    <div class="stat-label">å¯ç”¨æ€»æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num text-green" id="directCountDisplay">{{ stats.direct|default(0) }}</div>
                    <div class="stat-label">ç›´è¿èŠ‚ç‚¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num text-yellow" id="landCountDisplay">{{ stats.land|default(0) }}</div>
                    <div class="stat-label">è½åœ°èŠ‚ç‚¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num text-red" id="blockedCountDisplay">{{ stats.blocked|default(0) }}</div>
                    <div class="stat-label">å±è”½èŠ‚ç‚¹</div>
                </div>
            </div>
            
            <div class="protocol-tags" id="protocolTagsContainer">
                {% for proto, count in stats.protocols.items() %}
                <div class="proto-tag">
                    <span class="proto-name">{{ proto }}</span>
                    <span class="proto-count">{{ count }}</span>
                </div>
                {% else %}
                <span style="color:#999; font-size:13px;">æš‚æ— èŠ‚ç‚¹æ•°æ®</span>
                {% endfor %}
            </div>
        </div>

        <div class="sub-card">
            <div class="card-header">
                <span class="card-title">ğŸ“ è§„åˆ™æ–‡ä»¶ç®¡ç†</span>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-custom-common btn-color-purple" onclick="openSubSettings()">è®¢é˜…é“¾æ¥è®¾ç½®</button>
                    <button class="btn-custom-common btn-color-blue" onclick="openNodeManager()">èŠ‚ç‚¹ç®¡ç†</button>
                    <button id="refreshStatsBtn" class="btn-custom-common btn-color-orange" onclick="refreshStats()">åˆ·æ–°èŠ‚ç‚¹ç¼“å­˜</button>
                </div>
            </div>
            
            <div class="rule-actions">
                <div class="btn-edit-rule" onclick="openEditor('direct.list', false)">
                    <span class="rule-icon">ğŸ¯</span>
                    <span class="rule-name">ç›´è¿è§„åˆ™</span>
                </div>
                <div class="btn-edit-rule" onclick="openEditor('customize.list', false)">
                    <span class="rule-icon">âš¡</span>
                    <span class="rule-name">è‡ªå®šä¹‰å‡ºç«™</span>
                </div>
                <div class="btn-edit-rule" onclick="openEditor('install-singbox.sh', false)">
                    <span class="rule-icon">ğŸ“œ</span>
                    <span class="rule-name">SingBox è„šæœ¬</span>
                </div>
                <div class="btn-edit-rule" onclick="openEditor('clash_meta.yaml', true)">
                    <span class="rule-icon">âš™ï¸</span>
                    <span class="rule-name">Clash æ¨¡æ¿</span>
                </div>
            </div>
            
            <p style="text-align: center; font-size: 12px; color: #999; margin-top: 10px;">
                ç‚¹å‡»å›¾æ ‡åœ¨çº¿ç¼–è¾‘åˆ†æµè§„åˆ™ã€è„šæœ¬æˆ–é…ç½®æ–‡ä»¶æ¨¡æ¿
            </p>
        </div>
    </div>

    <div class="subscription-list">
        
        <div class="sub-card-compact">
            <div class="card-header">
                <span class="card-title">ğŸš€ Clash è®¢é˜…</span>
                <span class="card-desc-compact">å…¨æ‰˜ç®¡æ¨¡å¼ï¼ŒåŒ…å«è§„åˆ™ä¸ç­–ç•¥ç»„ (Clash Verge/Meta)</span>
            </div>
            <div class="sub-link-row">
                <input type="text" class="link-input" id="clashUrl" value="{{ clash_url }}" readonly 
                       title="ç‚¹å‡»å¤åˆ¶ Clash è®¢é˜…é“¾æ¥"
                       onclick="copyToClipboard(this.value, 'Clash è®¢é˜…é“¾æ¥')">
            </div>
        </div>

        <div class="sub-card-compact">
            <div class="card-header">
                <span class="card-title">ğŸŒŒ V2Ray è®¢é˜…</span>
                <span class="card-desc-compact">çº¯èŠ‚ç‚¹åˆ—è¡¨ (Base64)ï¼Œä¸å«è§„åˆ™ (v2rayN/Passwall)</span>
            </div>
            <div class="sub-link-row">
                <input type="text" class="link-input" id="v2rayUrl" value="{{ v2ray_url }}" readonly
                       title="ç‚¹å‡»å¤åˆ¶ V2Ray è®¢é˜…é“¾æ¥"
                       onclick="copyToClipboard(this.value, 'V2Ray è®¢é˜…é“¾æ¥')">
            </div>
        </div>

        <div class="sub-card-expanded">
            <div class="card-header">
                <span class="card-title">ğŸ“¦ SingBox ä¸€é”®å®‰è£… (é“¾æ¥èšåˆé»˜è®¤å‚æ•°)</span>
                <span class="card-desc-compact">é€‰æ‹©éœ€è¦çš„åè®®ç”Ÿæˆå®‰è£…å‘½ä»¤</span>
            </div>
            
            <div class="protocol-selector" id="singboxProtocols">
                <label class="checkbox-label"><input type="checkbox" value="vless" checked onchange="updateSingboxCmd()"> Vless</label>
                <label class="checkbox-label"><input type="checkbox" value="shadowsocks" onchange="updateSingboxCmd()"> Shadowsocks</label>
                <label class="checkbox-label"><input type="checkbox" value="hysteria2" checked onchange="updateSingboxCmd()"> Hysteria2</label>
                <label class="checkbox-label"><input type="checkbox" value="tuic" onchange="updateSingboxCmd()"> Tuic</label>

                <div style="width: 1-px; height: 16px; background: #ddd; margin: 0 10px;"></div>
                <label class="checkbox-label" style="color: #007aff; font-weight: 600;">
                    <input type="checkbox" id="autoReportToggle" onchange="updateSingboxCmd()"> 
                    â˜ï¸ è‡ªåŠ¨æ·»åŠ åˆ°èŠ‚ç‚¹åˆ—è¡¨
                </label>
            </div>

            <div class="sub-link-row">
                <input type="text" class="link-input" id="singboxCmd" readonly 
                       style="color: #6c5ce7; font-weight: 500;"
                       title="ç‚¹å‡»å¤åˆ¶ SingBox å®‰è£…å‘½ä»¤"
                       onclick="copyToClipboard(this.value, 'SingBox å®‰è£…å‘½ä»¤')">
            </div>
        </div>

    </div>

</div>

<div id="subSettingsModal" class="modal-overlay">
    <div class="editor-box" style="width: 480px; height: auto; padding: 30px;" onclick="event.stopPropagation()">
        
        <div style="flex: 1; display: flex; flex-direction: column; gap: 24px;">
            
            <div class="form-group">
                <div class="form-header">
                    <label class="form-label" style="font-size: 14px; margin-bottom: 0; color: #333;">å›ºå®šå¤–éƒ¨è®¿é—®åœ°å€</label>
                    <button class="btn-mini btn-mini-blue" id="btnSaveDomain" onclick="saveDomainSetting()">ä¿å­˜åœ°å€è®¾ç½®</button>
                </div>
                <input type="text" id="settingFixedDomain" class="add-input" placeholder="" value="{{ settings.fixed_domain }}" style="background: #f9f9fc;">
                <p style="font-size: 12px; color: #999; margin-top: 6px; line-height: 1.5;">
                    å¦‚æœä¸å¡«å†™ï¼Œç³»ç»Ÿå°†å°è¯•è‡ªåŠ¨æ£€æµ‹ã€‚<br>å¡«å†™åï¼Œæ‰€æœ‰è®¢é˜…é“¾æ¥å°†å¼ºåˆ¶ä½¿ç”¨æ­¤å‰ç¼€ã€‚
                </p>
            </div>

            <div style="border-top: 1px solid #f0f0f0;"></div>

            <div class="form-group">
                <div class="form-header">
                    <label class="form-label" style="font-size: 14px; margin-bottom: 0; color: #333;">å®‰å…¨è®¿é—® Token</label>
                    <div style="display: flex; gap: 8px;">
                        <button id="btnRefreshToken" class="btn-mini btn-mini-gray" onclick="refreshApiToken()" title="ç”Ÿæˆæ–° Token">
                            éšæœºåˆ·æ–°
                        </button>
                        <button id="btnSaveToken" class="btn-mini btn-mini-green" onclick="saveTokenManual()" title="ä¿å­˜æ‰‹åŠ¨è¾“å…¥çš„ Token">
                            ä¿å­˜ Token
                        </button>
                    </div>
                </div>
                
                <input type="text" id="settingToken" class="add-input" value="{{ settings.api_token }}" style="font-family: monospace; color: #333;">
                
                <p style="font-size: 12px; color: #d74242; margin-top: 6px;">
                    æ³¨æ„ï¼šä¿®æ”¹æˆ–åˆ·æ–° Token åï¼Œæ—§çš„è®¢é˜…é“¾æ¥å°†ç«‹å³å¤±æ•ˆã€‚
                </p>
            </div>

        </div>

        <div class="modal-footer-buttons" style="margin-top: 30px; padding-top: 0; border-top: none;">
            <button class="btn-close-modal" onclick="closeSubSettings()">é€€å‡º</button>
        </div>
    </div>
</div>

<div id="editorModal" class="modal-overlay">
    <div class="editor-box" onclick="event.stopPropagation()">
        <div class="editor-header">
            <span class="editor-title" id="editorFileName">ç¼–è¾‘æ–‡ä»¶</span>
            <span class="close-btn" onclick="closeEditor()" style="cursor:pointer; font-size:24px;">Ã—</span>
        </div>
        
        <textarea id="fileContent" class="editor-textarea" placeholder="åŠ è½½ä¸­..." spellcheck="false"></textarea>
        <input type="hidden" id="currentFileName" data-is-template="false"> 

        <div class="editor-footer">
            <button class="btn-save" onclick="saveFile()">ä¿å­˜æ›´æ”¹</button>
        </div>
    </div>
</div>

<div id="nodeManagerModal" class="modal-overlay">
    <div class="editor-box" id="nodeManagerBox" onclick="event.stopPropagation()">
        <div class="editor-header" style="border-bottom: none; margin-bottom: 5px; padding-bottom: 0;"></div>
        
        <div class="node-manager-container" id="nodeManagerGrid">
            
            <div class="node-column" id="col-direct" data-title="ç›´è¿">
                <div class="node-list" id="list-direct"></div>
            </div>

            <div class="node-column" id="col-land" data-title="è½åœ°">
                <div class="node-list" id="list-land"></div>
            </div>

            <div class="node-column" id="col-blocked" data-title="å±è”½">
                <div class="node-list" id="list-blocked"></div>
            </div>

            <div class="node-column" id="col-add" data-title="æ·»åŠ èŠ‚ç‚¹">
                <div class="add-form">
                    
                    <div class="form-group">
                        <div class="form-header">
                            <label class="form-label" style="margin-bottom: 0;">è®¢é˜…æ¥æºåˆ—è¡¨</label>
                            <div style="display: flex; gap: 6px;">
                                <button type="button" class="btn-mini btn-mini-gray" onclick="addSubEntry()">æ–°å¢è®¢é˜…</button>
                                <button type="button" class="btn-mini btn-mini-blue" id="btnSaveSubList" onclick="saveSubEntryList()">ä¿å­˜åˆ—è¡¨</button>
                            </div>
                        </div>
                        <div id="subUrlList" class="sub-url-list"></div>
                        <p style="font-size: 12px; color: #999; margin-top: 6px;">æ”¯æŒå¤šæ¡è®¢é˜…é“¾æ¥ï¼Œä¿å­˜åç”¨äºåŒæ­¥ã€‚</p>
                    </div>

                    <div class="form-group">
                        <div class="form-header">
                            <label class="form-label" style="margin-bottom: 0;">è‡ªåŠ¨åŒæ­¥è®¾ç½®</label>
                            <button type="button" class="btn-mini btn-mini-blue" id="btnSaveAutoSync" onclick="saveAutoSyncSettings()">ä¿å­˜è‡ªåŠ¨åŒæ­¥</button>
                        </div>
                        <div class="auto-sync-row">
                            <label class="switch" title="å¯ç”¨åæŒ‰ç…§è®¾å®šé—´éš”è‡ªåŠ¨åŒæ­¥">
                                <input type="checkbox" id="subAutoEnabled">
                                <span class="slider"></span>
                            </label>
                            <div style="flex: 1; min-width: 140px;">
                                <label class="form-label" style="margin-bottom: 4px;">é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                                <input type="number" min="1" id="subAutoInterval" class="sub-entry-url" style="margin-top: 0;">
                            </div>
                        </div>
                        <p class="auto-sync-hint" id="autoSyncStatusText">è‡ªåŠ¨åŒæ­¥çŠ¶æ€æœªçŸ¥</p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn-add-large" id="btnFetchSub" onclick="fetchFromSubscription()" style="flex: 1; background-color: #6c5ce7;">æ›´æ–°è®¢é˜…</button>
                        <button class="btn-add-large" onclick="clearSubscriptionNodes()" style="flex: 1; background-color: #d74242; font-size: 13px;">æ¸…é™¤è®¢é˜…èŠ‚ç‚¹</button>
                    </div>

                    <div id="subReportPanel" class="sub-report-panel" style="display:none;"></div>

                    <div style="border-bottom: 1px dashed #ddd; margin: 2px 0;"></div>
                    <div class="form-group" style="margin-top: 10px; margin-bottom: 10px;">
                        <label class="form-label">èŠ‚ç‚¹åç§° (åŒåè‡ªåŠ¨åˆå¹¶)</label>
                        <input type="text" id="newNodeName" class="add-input">
                    </div>
                    <div class="form-group" style="margin-top: -10px; margin-bottom: 10px;">
                        <label class="form-label">åè®®ç±»å‹</label>
                        <select id="newNodeProtocol" class="add-select">
                            <option value="vless">Vless</option>
                            <option value="hy2">Hysteria2</option>
                            <option value="ss">Shadowsocks</option>
                            <option value="tuic">Tuic</option>
                            <option value="socks5">Socks5</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                        <label class="form-label">èŠ‚ç‚¹é“¾æ¥</label>
                        <textarea id="newNodeLink" class="add-input" style="flex: 1; resize: none;"></textarea>
                    </div>

                    <div class="add-btn-row">
                        <button class="btn-add-large" onclick="addLocalNode()" style="flex: 1;">æ·»åŠ </button>
                    </div>
                </div>
            </div>

            <div class="node-column" id="col-details" data-title="èŠ‚ç‚¹è¯¦æƒ…">
                <div id="detailsContent">
                    <div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #999;">
                        è¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹
                    </div>
                </div>
            </div>

        </div>

        <div class="editor-footer modal-footer-buttons">
            <button class="btn-close-modal" onclick="closeNodeManager()">é€€å‡º</button>
            <button class="btn-save" onclick="saveNodeConfig()">ä¿å­˜é…ç½®</button>
        </div>
        
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // å®šä¹‰å¸¸é‡
    const modal = document.getElementById('editorModal');
    const nodeModal = document.getElementById('nodeManagerModal');
    const nodeManagerBox = document.getElementById('nodeManagerBox');
    const textarea = document.getElementById('fileContent');
    const title = document.getElementById('editorFileName');
    const hiddenInput = document.getElementById('currentFileName');

    // åè®®æ˜ å°„è¡¨
    const PROTOCOL_MAP = {
        'hy2': 'Hysteria2',
        'vless': 'VLESS',
        'vmess': 'VMess',
        'trojan': 'Trojan',
        'ss': 'Shadowsocks',
        'tuic': 'TUIC',
        'socks5': 'Socks5',
        'shadowsocks': 'Shadowsocks',
        'hysteria2': 'Hysteria2'
    };

    let SUB_ENTRIES = [];
    try {
        SUB_ENTRIES = {{ settings.external_subscriptions | tojson | safe }} || [];
    } catch (err) {
        SUB_ENTRIES = [];
    }
    if (!Array.isArray(SUB_ENTRIES)) {
        SUB_ENTRIES = [];
    }

    const SUB_AUTO_ENABLED = {{ settings.sub_auto_enabled | default(false) | tojson | safe }};
    const SUB_AUTO_INTERVAL = {{ settings.sub_auto_interval | default(30) }};

    function randomSubId() {
        if (window.crypto && window.crypto.randomUUID) {
            return window.crypto.randomUUID();
        }
        return 'sub-' + Math.random().toString(36).slice(2, 10);
    }

    function normalizeSubEntry(entry, idx = 0) {
        return {
            id: entry.id || randomSubId(),
            name: entry.name || '',
            url: entry.url || '',
            note: entry.note || '',
            enabled: entry.enabled !== false,
            last_status: entry.last_status || 'pending',
            last_message: entry.last_message || '',
            last_synced_at: entry.last_synced_at || null,
            last_trigger: entry.last_trigger || '',
            order: typeof entry.order === 'number' ? entry.order : idx
        };
    }

    SUB_ENTRIES = SUB_ENTRIES.map((entry, idx) => normalizeSubEntry(entry, idx));
    SUB_ENTRIES.sort((a, b) => (a.order || 0) - (b.order || 0));

    const baseScriptUrl = "{{ script_url }}";
    const callbackUrl = "{{ callback_url }}"; 

    // å…¨å±€å˜é‡å­˜å‚¨æ‰€æœ‰èŠ‚ç‚¹æ•°æ®
    let GLOBAL_NODES = {};

    document.addEventListener('DOMContentLoaded', function() {
        updateSingboxCmd();
        setupDragColumns();
        renderSubEntryList();
        initAutoSyncForm();
    });

    // --- è®¢é˜…åˆ—è¡¨ç®¡ç† ---
    function renderSubEntryList() {
        const container = document.getElementById('subUrlList');
        if (!container) return;
        container.innerHTML = '';
        if (!SUB_ENTRIES.length) {
            container.innerHTML = '<div class="sub-url-empty">æš‚æ— è®¢é˜…é“¾æ¥ï¼Œç‚¹å‡»â€œæ–°å¢è®¢é˜…â€æ·»åŠ </div>';
            return;
        }

        SUB_ENTRIES.forEach((entry, index) => {
            const card = document.createElement('div');
            card.className = 'sub-entry-card';

            const topRow = document.createElement('div');
            topRow.className = 'sub-entry-top';

            const aliasInput = document.createElement('input');
            aliasInput.type = 'text';
            aliasInput.className = 'sub-entry-alias';
            aliasInput.placeholder = 'åˆ«å / å¤‡æ³¨ (å¯é€‰)';
            aliasInput.value = entry.name || '';
            aliasInput.addEventListener('input', (e) => {
                SUB_ENTRIES[index].name = e.target.value;
            });

            const enableLabel = document.createElement('label');
            enableLabel.style.display = 'flex';
            enableLabel.style.alignItems = 'center';
            enableLabel.style.gap = '4px';
            enableLabel.style.fontSize = '12px';
            enableLabel.style.color = '#555';
            const enableToggle = document.createElement('input');
            enableToggle.type = 'checkbox';
            enableToggle.checked = entry.enabled !== false;
            enableToggle.addEventListener('change', (e) => {
                SUB_ENTRIES[index].enabled = e.target.checked;
            });
            enableLabel.appendChild(enableToggle);
            enableLabel.appendChild(document.createTextNode('å¯ç”¨'));

            topRow.appendChild(aliasInput);
            topRow.appendChild(enableLabel);

            const urlInput = document.createElement('input');
            urlInput.type = 'text';
            urlInput.className = 'sub-entry-url';
            urlInput.placeholder = 'https://example.com/subscription.txt';
            urlInput.value = entry.url || '';
            urlInput.addEventListener('input', (e) => {
                SUB_ENTRIES[index].url = e.target.value.trim();
            });

            const noteInput = document.createElement('textarea');
            noteInput.className = 'sub-entry-note';
            noteInput.placeholder = 'å¤‡æ³¨ä¿¡æ¯ / ç”¨é€”è¯´æ˜ (å¯é€‰)';
            noteInput.value = entry.note || '';
            noteInput.addEventListener('input', (e) => {
                SUB_ENTRIES[index].note = e.target.value;
            });

            const metaRow = document.createElement('div');
            metaRow.className = 'sub-entry-meta';
            const lastSync = document.createElement('span');
            lastSync.textContent = formatLastSync(entry);
            const statusSpan = document.createElement('span');
            const statusClass = getStatusClass(entry.last_status);
            statusSpan.className = `status-pill ${statusClass}`;
            statusSpan.textContent = getStatusLabel(entry.last_status);
            metaRow.appendChild(lastSync);
            metaRow.appendChild(statusSpan);

            const actionsRow = document.createElement('div');
            actionsRow.className = 'sub-entry-actions';

            const upBtn = document.createElement('button');
            upBtn.type = 'button';
            upBtn.className = 'btn-entry-action';
            upBtn.textContent = 'ä¸Šç§»';
            upBtn.disabled = index === 0;
            upBtn.addEventListener('click', () => moveSubEntry(index, -1));

            const downBtn = document.createElement('button');
            downBtn.type = 'button';
            downBtn.className = 'btn-entry-action';
            downBtn.textContent = 'ä¸‹ç§»';
            downBtn.disabled = index === SUB_ENTRIES.length - 1;
            downBtn.addEventListener('click', () => moveSubEntry(index, 1));

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-entry-action';
            removeBtn.style.color = '#d74242';
            removeBtn.textContent = 'åˆ é™¤';
            removeBtn.addEventListener('click', () => removeSubEntry(index));

            actionsRow.appendChild(upBtn);
            actionsRow.appendChild(downBtn);
            actionsRow.appendChild(removeBtn);

            card.appendChild(topRow);
            card.appendChild(urlInput);
            card.appendChild(noteInput);
            card.appendChild(metaRow);
            card.appendChild(actionsRow);
            container.appendChild(card);
        });
    }

    function formatDateTime(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleString();
    }

    function formatLastSync(entry) {
        if (!entry.last_synced_at) {
            return 'ä»æœªåŒæ­¥';
        }
        const formatted = formatDateTime(entry.last_synced_at);
        if (!formatted) {
            return 'åŒæ­¥æ—¶é—´æœªçŸ¥';
        }
        const trigger = entry.last_trigger ? `ï¼ˆ${formatTrigger(entry.last_trigger)}ï¼‰` : '';
        return `æœ€ååŒæ­¥ï¼š${formatted}${trigger}`;
    }

    function formatTrigger(trigger) {
        if (!trigger) return '';
        if (trigger.startsWith('user:')) {
            return `ç”¨æˆ· ${trigger.split(':')[1]}`;
        }
        if (trigger === 'scheduler') return 'è‡ªåŠ¨ä»»åŠ¡';
        return trigger;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'success': return 'status-success';
            case 'error': return 'status-error';
            case 'empty': return 'status-empty';
            case 'warning': return 'status-warning';
            default: return 'status-pending';
        }
    }

    function getStatusLabel(status) {
        switch (status) {
            case 'success': return 'æˆåŠŸ';
            case 'error': return 'å¤±è´¥';
            case 'empty': return 'æ— æ•°æ®';
            case 'warning': return 'è­¦å‘Š';
            case 'disabled': return 'å·²ç¦ç”¨';
            default: return 'æœªåŒæ­¥';
        }
    }

    function addSubEntry() {
        SUB_ENTRIES.push(normalizeSubEntry({ id: randomSubId(), enabled: true }, SUB_ENTRIES.length));
        renderSubEntryList();
    }

    function removeSubEntry(index) {
        SUB_ENTRIES.splice(index, 1);
        renderSubEntryList();
    }

    function moveSubEntry(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= SUB_ENTRIES.length) return;
        const [item] = SUB_ENTRIES.splice(index, 1);
        SUB_ENTRIES.splice(newIndex, 0, item);
        renderSubEntryList();
    }

    function getLatestSubSyncTime() {
        let latestTs = null;
        SUB_ENTRIES.forEach(entry => {
            if (!entry.last_synced_at) return;
            const parsed = Date.parse(entry.last_synced_at);
            if (!isNaN(parsed) && (latestTs === null || parsed > latestTs)) {
                latestTs = parsed;
            }
        });
        return latestTs ? new Date(latestTs).toISOString() : null;
    }

    function initAutoSyncForm() {
        const toggle = document.getElementById('subAutoEnabled');
        const intervalInput = document.getElementById('subAutoInterval');
        if (!toggle || !intervalInput) return;
        toggle.checked = !!SUB_AUTO_ENABLED;
        intervalInput.value = SUB_AUTO_INTERVAL || 30;
        toggle.addEventListener('change', () => updateAutoSyncStatusText());
        intervalInput.addEventListener('change', () => {
            if (intervalInput.value <= 0) {
                intervalInput.value = 1;
            }
            updateAutoSyncStatusText();
        });
        updateAutoSyncStatusText(getLatestSubSyncTime());
    }

    function updateAutoSyncStatusText(latestSyncedAt = null) {
        const textEl = document.getElementById('autoSyncStatusText');
        const toggle = document.getElementById('subAutoEnabled');
        const intervalInput = document.getElementById('subAutoInterval');
        if (!textEl || !toggle || !intervalInput) return;
        const enabled = toggle.checked;
        let interval = parseInt(intervalInput.value, 10);
        if (isNaN(interval) || interval < 1) {
            interval = 1;
            intervalInput.value = 1;
        }
        const effectiveSyncedAt = latestSyncedAt || getLatestSubSyncTime();
        const statusText = enabled ? `å·²å¼€å¯ï¼Œæ¯ ${interval} åˆ†é’Ÿæ‰§è¡Œ` : 'å·²å…³é—­';
        const triggerHint = enabled ? ' ï½œ å°†è‡ªåŠ¨åå°åŒæ­¥' : '';
        const formattedTime = effectiveSyncedAt ? formatDateTime(effectiveSyncedAt) : '';
        const syncText = formattedTime ? ` ï½œ æœ€è¿‘åŒæ­¥ï¼š${formattedTime}` : '';
        textEl.textContent = statusText + triggerHint + syncText;
    }

    function saveAutoSyncSettings() {
        const toggle = document.getElementById('subAutoEnabled');
        const intervalInput = document.getElementById('subAutoInterval');
        const btn = document.getElementById('btnSaveAutoSync');
        if (!toggle || !intervalInput || !btn) return;

        let interval = parseInt(intervalInput.value, 10);
        if (isNaN(interval) || interval < 1) {
            interval = 1;
        }
        intervalInput.value = interval;

        const payload = {
            sub_auto_enabled: toggle.checked,
            sub_auto_interval: interval
        };

        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'ä¿å­˜ä¸­...';

        fetch("{{ url_for('subscription.update_settings_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(res => {
            if (res.status === 'success') {
                showToast('âœ… è‡ªåŠ¨åŒæ­¥è®¾ç½®å·²ä¿å­˜');
                updateAutoSyncStatusText();
            } else {
                showToast('âŒ ä¿å­˜å¤±è´¥', 'error');
            }
        })
        .catch(err => {
            console.error(err);
            showToast('âŒ ä¿å­˜å¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = originalText;
        });
    }

    function getSubItemsPayload() {
        return SUB_ENTRIES.map((entry, idx) => ({
            id: entry.id || randomSubId(),
            name: entry.name || '',
            url: entry.url || '',
            note: entry.note || '',
            enabled: entry.enabled !== false,
            order: idx
        }));
    }

    function saveSubEntryList() {
        const payload = getSubItemsPayload();
        const btn = document.getElementById('btnSaveSubList');
        const original = btn ? btn.innerText : '';
        if (btn) {
            btn.disabled = true;
            btn.innerText = 'ä¿å­˜ä¸­...';
        }
        fetch("{{ url_for('subscription.update_settings_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sub_items: payload })
        })
        .then(r => r.json())
        .then(res => {
            if (res.status === 'success') {
                showToast('âœ… è®¢é˜…åˆ—è¡¨å·²ä¿å­˜');
            } else {
                showToast('âŒ ä¿å­˜å¤±è´¥', 'error');
            }
        })
        .finally(() => {
            if (btn) {
                btn.disabled = false;
                btn.innerText = original || 'ä¿å­˜åˆ—è¡¨';
            }
        });
    }

    // --- SingBox å‘½ä»¤ç”Ÿæˆ ---
    function updateSingboxCmd() {
        const checkboxes = document.querySelectorAll('#singboxProtocols input[type="checkbox"]:not(#autoReportToggle):checked');
        const autoReport = document.getElementById('autoReportToggle').checked;
        const selectedProtocols = Array.from(checkboxes).map(cb => cb.value);
        
        let cmd = `bash -c "$(curl -fsSL ${baseScriptUrl})"`;
        let args = [...selectedProtocols];
        if (autoReport) {
            args.push('--report', `"${callbackUrl}"`);
        }
        if (args.length > 0) {
            cmd += ` -- ${args.join(' ')}`;
        }
        document.getElementById('singboxCmd').value = cmd;
    }

    // --- å¤åˆ¶å‡½æ•° ---
    function copyToClipboard(text, desc) {
        if (!text) return;
        
        // ä½¿ç”¨ç°ä»£ Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`âœ… ${desc} å·²å¤åˆ¶`);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        } else {
            // å…¼å®¹æ€§å›é€€
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast(`âœ… ${desc} å·²å¤åˆ¶`);
                } else {
                    showToast('âŒ æµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                showToast('âŒ å¤åˆ¶å¤±è´¥', 'error');
            }
            document.body.removeChild(textArea);
        }
    }

    // æ—§çš„å¤åˆ¶å‡½æ•° (ç”¨äºè¯¦æƒ…é¡µå†…)
    function copyText(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            showToast('âœ… å·²å¤åˆ¶');
        }).catch(() => {
            showToast('âŒ å¤åˆ¶å¤±è´¥', 'error');
        });
    }

    // --- åˆ·æ–°ç»Ÿè®¡ ---
    function refreshStats() {
        const btn = document.getElementById('refreshStatsBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'è¯»å–ä¸­...'; 
        
        fetch("{{ url_for('subscription.get_stats_api') }}")
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                updateStatsUI(data.stats);
                showToast('âœ… èŠ‚ç‚¹ç¼“å­˜å·²åˆ·æ–°');
            } else {
                showToast('âŒ è·å–å¤±è´¥: ' + data.message, 'error');
            }
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = 'åˆ·æ–°èŠ‚ç‚¹ç¼“å­˜'; // ä¿æŒæ–°åç§°
        });
    }

    function updateStatsUI(stats) {
        document.getElementById('totalCountDisplay').innerText = stats.total;
        document.getElementById('directCountDisplay').innerText = stats.direct || 0;
        document.getElementById('landCountDisplay').innerText = stats.land || 0;
        // ğŸš¨ ä¿®æ”¹å¤„ï¼šæ›´æ–°å±è”½èŠ‚ç‚¹ç»Ÿè®¡
        document.getElementById('blockedCountDisplay').innerText = stats.blocked || 0;
        
        const container = document.getElementById('protocolTagsContainer');
        container.innerHTML = ''; 
        if (!stats.protocols || Object.keys(stats.protocols).length === 0) {
            container.innerHTML = '<span style="color:#999; font-size:13px;">æš‚æ— èŠ‚ç‚¹æ•°æ®</span>';
        } else {
            const sortedProtocols = Object.entries(stats.protocols).sort(([a], [b]) => a.localeCompare(b));
            for (const [proto, count] of sortedProtocols) {
                container.innerHTML += `<div class="proto-tag"><span class="proto-name">${proto}</span><span class="proto-count">${count}</span></div>`;
            }
        }
    }

    // --- æ–‡æœ¬ç¼–è¾‘å™¨é€»è¾‘ ---
    function openEditor(filename, isTemplate = false) {
        modal.classList.add('active');
        const apiPath = isTemplate ? "{{ url_for('subscription.handle_rule_template') }}" : "{{ url_for('subscription.handle_rules') }}";
        const fetchUrl = isTemplate ? apiPath : `${apiPath}?file=${filename}`;
        title.innerText = isTemplate ? 'ç¼–è¾‘ Clash é…ç½®æ¨¡æ¿' : `ç¼–è¾‘ ${filename}`;
        hiddenInput.value = filename;
        hiddenInput.dataset.isTemplate = isTemplate; 
        textarea.value = "åŠ è½½ä¸­...";
        textarea.disabled = true;

        fetch(fetchUrl).then(r => r.json()).then(res => {
            if (res.status === 'success') {
                textarea.value = res.content;
                textarea.disabled = false;
            } else {
                textarea.value = "åŠ è½½å¤±è´¥";
            }
        });
    }

    function closeEditor() { modal.classList.remove('active'); }
    
    function saveFile() {
        const filename = hiddenInput.value;
        const isTemplate = hiddenInput.dataset.isTemplate === 'true'; 
        const content = textarea.value;
        const apiPath = isTemplate ? "{{ url_for('subscription.handle_rule_template') }}" : "{{ url_for('subscription.handle_rules') }}";
        const fetchUrl = isTemplate ? apiPath : `${apiPath}?file=${filename}`;
        
        fetch(fetchUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        }).then(r => r.json()).then(res => {
            if (res.status === 'success') { showToast('âœ… ä¿å­˜æˆåŠŸ'); closeEditor(); }
            else { showToast('âŒ ä¿å­˜å¤±è´¥', 'error'); }
        });
    }

    // --- èŠ‚ç‚¹ç®¡ç†å™¨é€»è¾‘ ---
    function openNodeManager() {
        nodeModal.classList.add('active');
        document.getElementById('nodeManagerGrid').classList.remove('details-open');
        nodeManagerBox.classList.remove('details-open'); 
        fetchNodes();
    }

    function closeNodeManager() {
        nodeModal.classList.remove('active');
        nodeManagerBox.classList.remove('details-open'); 
    }
    
    function closeDetailsPanel() {
        document.getElementById('nodeManagerGrid').classList.remove('details-open');
        nodeManagerBox.classList.remove('details-open');
        document.querySelectorAll('.node-item').forEach(el => el.classList.remove('selected'));
        // å»¶è¿Ÿæ¸…ç©ºå†…å®¹ï¼Œé¿å…åŠ¨ç”»æ—¶å†…å®¹çªç„¶æ¶ˆå¤±
        setTimeout(() => {
            document.getElementById('detailsContent').innerHTML = '<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #999;">è¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹</div>';
        }, 300);
    }

    function fetchNodes(preserveUuid = null) {
        const listDirect = document.getElementById('list-direct');
        const listBlocked = document.getElementById('list-blocked');
        const listLand = document.getElementById('list-land');
        
        // è·å–å½“å‰é€‰ä¸­çš„UUIDï¼ˆå¦‚æœæ²¡æœ‰ä¼ å…¥ç‰¹å®šUUIDï¼‰
        let targetUuid = preserveUuid;
        if (!targetUuid) {
            const currentSelected = document.querySelector('.node-item.selected');
            if (currentSelected) targetUuid = currentSelected.dataset.uuid;
        }

        [listDirect, listBlocked, listLand].forEach(el => el.innerHTML = '<div style="text-align:center; padding:10px; color:#999;">åŠ è½½ä¸­...</div>');

        fetch("{{ url_for('subscription.get_nodes_list_api') }}")
        .then(r => r.json())
        .then(res => {
            if(res.status === 'success') {
                GLOBAL_NODES = {};
                res.nodes.forEach(n => GLOBAL_NODES[n.uuid] = n);
                
                renderNodeLists(res.nodes);
                
                // åˆ·æ–°åå¦‚æœç›®æ ‡èŠ‚ç‚¹è¿˜å­˜åœ¨ï¼Œåˆ™é‡æ–°é€‰ä¸­å¹¶æ¸²æŸ“è¯¦æƒ…
                if(targetUuid && GLOBAL_NODES[targetUuid]) {
                    const newItem = document.getElementById(`node-${targetUuid}`);
                    if(newItem) newItem.classList.add('selected');
                    
                    document.getElementById('nodeManagerGrid').classList.add('details-open');
                    nodeManagerBox.classList.add('details-open');
                    // é‡æ–°æ¸²æŸ“è¯¦æƒ…ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
                    renderDetailsPanel(document.getElementById('detailsContent'), GLOBAL_NODES[targetUuid]);
                } else if (!targetUuid) {
                    closeDetailsPanel();
                } else {
                    closeDetailsPanel();
                }

            } else {
                showToast('âŒ åŠ è½½èŠ‚ç‚¹å¤±è´¥: ' + res.message, 'error');
            }
        });
    }

    function renderNodeLists(nodes) {
        const listDirect = document.getElementById('list-direct');
        const listLand = document.getElementById('list-land');
        const listBlocked = document.getElementById('list-blocked');
        
        listDirect.innerHTML = '';
        listLand.innerHTML = '';
        listBlocked.innerHTML = '';

        nodes.forEach(node => {
            const el = createNodeElement(node);
            if (node.routing_type === 0) listDirect.appendChild(el);
            else if (node.routing_type === 1) listLand.appendChild(el);
            else listBlocked.appendChild(el);
        });
    }

    function createNodeElement(node) {
        const div = document.createElement('div');
        div.className = `node-item`; 
        div.id = `node-${node.uuid}`; 
        div.dataset.uuid = node.uuid;
        div.dataset.isLocal = node.is_local; 
        
        // å¼€å¯æ‹–æ‹½
        div.draggable = true;
        addDragEvents(div);

        div.onclick = function() {
            showNodeDetails(node.uuid);
        };

        let headerContent = `<div class="node-content-block">
            <div class="node-top-row">
                <span class="node-name-text" title="${node.name}">${node.name}</span>`;
        
        // æ ‡è¯†åŒºåˆ†
        if (node.is_sub) {
             headerContent += `<span class="sub-badge">SUB</span>`;
        } else if (node.is_db) {
            headerContent += `<span class="db-badge">DB</span>`;
        } else {
            headerContent += `<span class="loc-badge">LOC</span>`;
        }
        
        headerContent += `</div>`; // end top-row

        if (node.protocols && node.protocols.length > 0) {
            headerContent += `<div class="protocol-badges">`;
            node.protocols.forEach(p => {
                const displayName = PROTOCOL_MAP[p] || p;
                const protoClass = p.toLowerCase();
                const knownProtos = ['vless', 'vmess', 'trojan', 'ss', 'shadowsocks', 'hy2', 'hysteria2', 'tuic', 'socks5'];
                const badgeClass = knownProtos.includes(protoClass) ? protoClass : 'other';
                headerContent += `<span class="proto-badge ${badgeClass}">${displayName}</span>`;
            });
            headerContent += `</div>`;
        }
        headerContent += `</div>`; 
        
        div.innerHTML = headerContent;
        return div;
    }

    // æ‹–æ‹½é€»è¾‘
    let dragSrcEl = null;

    function addDragEvents(item) {
        item.addEventListener('dragstart', handleDragStart, false);
        item.addEventListener('dragend', handleDragEnd, false);
    }
    
    function setupDragColumns() {
        const columns = document.querySelectorAll('.node-list');
        columns.forEach(col => {
            col.addEventListener('dragover', handleDragOver, false);
            col.addEventListener('drop', handleDrop, false);
        });
    }

    function handleDragStart(e) {
        this.classList.add('dragging');
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        
        // æ‹–åŠ¨æ—¶è‡ªåŠ¨é€‰ä¸­å½“å‰èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºè¯¦æƒ…
        showNodeDetails(this.dataset.uuid);
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault(); 
        }
        e.dataTransfer.dropEffect = 'move';

        const container = this; 
        const afterElement = getDragAfterElement(container, e.clientY);
        
        if (afterElement == null) {
            container.appendChild(dragSrcEl);
        } else {
            container.insertBefore(dragSrcEl, afterElement);
        }
        
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        showToast('ğŸ’¡ é¡ºåºå·²å˜æ›´ï¼Œè¯·ç‚¹å‡»â€œä¿å­˜é…ç½®â€ç”Ÿæ•ˆ', 'success');
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.node-item:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }


    // --- æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ… ---
    function showNodeDetails(uuid) {
        const node = GLOBAL_NODES[uuid];
        if (!node) return;

        document.querySelectorAll('.node-item').forEach(el => el.classList.remove('selected'));
        const activeEl = document.getElementById(`node-${uuid}`);
        if (activeEl) activeEl.classList.add('selected');

        const detailsContainer = document.getElementById('detailsContent');
        renderDetailsPanel(detailsContainer, node);

        document.getElementById('nodeManagerGrid').classList.add('details-open');
        nodeManagerBox.classList.add('details-open');
    }

    function renderDetailsPanel(container, node) {
        container.dataset.uuid = node.uuid;
        const isDb = !node.is_local;
        
        // 1. æ„å»ºæ»šåŠ¨åŒºåŸŸ (Name Input + Links)
        let html = `<div class="details-scroll-area">`;
        
        // --- é¡¶éƒ¨ä¿¡æ¯ç»„ (ä»…èŠ‚ç‚¹åç§°) ---
        html += `
            <div class="detail-info-group">
                <div class="details-name-row">
                    <input type="text" id="detailNodeName" class="details-name-input" value="${node.name.replace(/"/g, '&quot;')}" placeholder="èŠ‚ç‚¹åç§°">
                </div>
            </div>
            
            <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
        `;

        // --- é“¾æ¥åˆ—è¡¨ (åè®®å†…å®¹) ---
        if (node.links && Object.keys(node.links).length > 0) {
            for (const [proto, link] of Object.entries(node.links)) {
                const displayName = PROTOCOL_MAP[proto] || proto;
                html += `
                <div class="detail-row" data-protocol="${proto}">
                    <div class="detail-top">
                        <span class="detail-proto-name">${displayName}</span>
                        ${!isDb ? `<button class="btn-del-proto" onclick="deleteLocalProtocol('${node.uuid}', '${proto}')">åˆ é™¤åè®®</button>` : ''}
                    </div>
                    <div class="detail-link-box">
                        <div class="detail-link" ${!isDb ? 'contenteditable="true"' : ''} id="link-${node.uuid}-${proto}">${link}</div>
                        <button class="btn-details-copy" onclick="copyText(document.getElementById('link-${node.uuid}-${proto}').innerText.trim())">å¤åˆ¶</button>
                    </div>
                </div>`;
            }
        } else {
            html += `<div style="padding:20px 0; text-align:center; color:#999; font-size:12px;">æš‚æ— é“¾æ¥è¯¦æƒ…</div>`;
        }
        
        html += `</div></div>`; 

        // 2. æ„å»ºåº•éƒ¨å›ºå®šåŒºåŸŸ (Close + Delete + Save Buttons)
        html += `
        <div class="details-bottom-fixed">
            <div class="details-action-buttons">
                <button class="btn-action-panel btn-close-panel" onclick="closeDetailsPanel()">å…³é—­</button>
                
                ${!node.is_db ? `<button class="btn-action-panel btn-delete-panel" onclick="deleteCurrentNode('${node.uuid}')">åˆ é™¤</button>` : ''}
                
                <button class="btn-action-panel btn-save-panel" id="btnSaveDetailsBottom" onclick="saveNodeDetails()">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
        `;
        
        container.innerHTML = html;
    }

    // åˆ é™¤å½“å‰èŠ‚ç‚¹ (è¯¦æƒ…é¡µè°ƒç”¨)
    function deleteCurrentNode(uuid) {
        if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹å—ï¼Ÿæ‰€æœ‰å…³è”çš„åè®®éƒ½ä¼šè¢«ç§»é™¤ã€‚')) return;
        
        fetch("{{ url_for('subscription.delete_local_node_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uuid: uuid })
        })
        .then(r => r.json())
        .then(res => {
            if(res.status === 'success') {
                closeDetailsPanel();
                const item = document.getElementById(`node-${uuid}`);
                if(item) item.remove();
                delete GLOBAL_NODES[uuid]; 
                showToast('ğŸ—‘ï¸ èŠ‚ç‚¹å·²åˆ é™¤');
                refreshStats();
            } else {
                showToast('âŒ åˆ é™¤å¤±è´¥: ' + res.message, 'error');
            }
        });
    }

    // --- èŠ‚ç‚¹æ“ä½œé€»è¾‘ ---
    function deleteLocalProtocol(uuid, protocol) {
        if(!confirm(`ç¡®å®šè¦åˆ é™¤èŠ‚ç‚¹ [${GLOBAL_NODES[uuid]?.name || uuid}] çš„åè®® [${protocol}] å—ï¼Ÿ`)) return;
        
        const currentUuid = uuid;

        fetch("{{ url_for('subscription.delete_local_node_protocol_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uuid: uuid, protocol: protocol })
        })
        .then(r => r.json())
        .then(res => {
            if(res.status === 'success') {
                showToast('âœ… ' + res.message);
                refreshStats();
                fetchNodes(currentUuid);
            } else {
                showToast('âŒ åˆ é™¤å¤±è´¥: ' + res.message, 'error');
            }
        });
    }

    function saveNodeDetails() {
        const detailsContainer = document.getElementById('detailsContent');
        const uuid = detailsContainer.dataset.uuid;
        const node = GLOBAL_NODES[uuid];
        if (!uuid || !node) {
            showToast('âŒ æ— æ³•è·å–èŠ‚ç‚¹ä¿¡æ¯', 'error');
            return;
        }

        const btn = document.getElementById('btnSaveDetailsBottom');
        const originalText = btn.innerText;
        btn.innerText = 'ä¿å­˜ä¸­...'; btn.disabled = true;

        const promises = [];

        // 1. å¤„ç†é‡å‘½å
        const nameInput = document.getElementById('detailNodeName');
        const newName = nameInput.value.trim();
        if (newName && newName !== node.name) {
            const renameReq = fetch("{{ url_for('subscription.rename_local_node_api') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uuid: uuid, name: newName })
            }).then(r => r.json());
            promises.push(renameReq);
        }

        // 2. å¤„ç†é“¾æ¥ä¿®æ”¹ (ä»…é™æœ¬åœ°èŠ‚ç‚¹)
        if (node.is_local) {
            const newLinks = {};
            const detailRows = detailsContainer.querySelectorAll('.detail-row');
            detailRows.forEach(row => {
                const protocol = row.dataset.protocol;
                const linkElement = row.querySelector(`#link-${uuid}-${protocol}`);
                if (linkElement) {
                    newLinks[protocol] = linkElement.innerText.trim();
                }
            });
            
            const updateLinkReq = fetch("{{ url_for('subscription.update_local_node_links_api') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uuid: uuid, links: newLinks })
            }).then(r => r.json());
            promises.push(updateLinkReq);
        }

        if (promises.length === 0) {
            showToast('âš ï¸ æœªæ£€æµ‹åˆ°æ›´æ”¹');
            btn.innerText = originalText; btn.disabled = false;
            return;
        }

        Promise.all(promises)
            .then(results => {
                const errors = results.filter(r => r.status !== 'success');
                if (errors.length > 0) {
                    showToast('âŒ ä¿å­˜éƒ¨åˆ†å¤±è´¥: ' + errors[0].message, 'error');
                } else {
                    showToast('âœ… æ‰€æœ‰æ›´æ”¹å·²ä¿å­˜');
                    fetchNodes(uuid); 
                }
            })
            .catch(err => {
                showToast('âŒ ç½‘ç»œé”™è¯¯: ' + err, 'error');
            })
            .finally(() => {
                if(document.body.contains(btn)) {
                     btn.innerText = originalText; 
                     btn.disabled = false;
                }
            });
    }
    // æ¸…é™¤æ‰€æœ‰è®¢é˜…èŠ‚ç‚¹
    function clearSubscriptionNodes() {
        if(!confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ¸…é™¤æ‰€æœ‰é€šè¿‡â€œè®¢é˜…é“¾æ¥â€è·å–çš„èŠ‚ç‚¹å—ï¼Ÿ')) return;

        // è·å–æŒ‰é’®ä»¥æ”¹å˜çŠ¶æ€
        const btn = document.querySelector('button[onclick="clearSubscriptionNodes()"]');
        const originalText = btn ? btn.innerText : 'æ¸…é™¤è®¢é˜…èŠ‚ç‚¹';
        if(btn) {
            btn.innerText = 'æ¸…é™¤ä¸­...';
            btn.disabled = true;
        }

        // å‡è®¾åç«¯æ–°å¢äº† clear_subscription_nodes_api è·¯ç”±
        fetch("{{ url_for('subscription.clear_subscription_nodes_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(res => {
            if (res.status === 'success') {
                showToast('âœ… è®¢é˜…èŠ‚ç‚¹å·²å…¨éƒ¨æ¸…é™¤');
                fetchNodes();   // é‡æ–°åŠ è½½åˆ—è¡¨
                refreshStats(); // åˆ·æ–°ç»Ÿè®¡
            } else {
                showToast('âŒ æ¸…é™¤å¤±è´¥: ' + res.message, 'error');
            }
        })
        .catch(err => {
            showToast('âŒ è¯·æ±‚å¤±è´¥: æ¥å£å¯èƒ½æœªå®ç°', 'error');
            console.error(err);
        })
        .finally(() => {
            if(btn) {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    }

    function fetchFromSubscription() {
        const active = SUB_ENTRIES.filter(item => item.enabled && item.url && item.url.trim());
        if (!active.length) {
            showToast('âš ï¸ è¯·å…ˆæ·»åŠ å¹¶å¯ç”¨è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆè®¢é˜…é“¾æ¥', 'error');
            return;
        }

        const payload = { sub_ids: active.map(item => item.id) };
        const btn = document.getElementById('btnFetchSub');
        const originalText = btn.innerText;
        btn.innerText = 'è·å–ä¸­...';
        btn.disabled = true;

        fetch("{{ url_for('subscription.fetch_from_sub_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(r => r.json().then(body => ({ ok: r.ok, body })))
        .then(({ ok, body }) => {
            if (!ok) throw new Error(body.message || 'è¯·æ±‚å¤±è´¥');

            const status = body.status || 'success';
            if (status === 'success') {
                showToast('âœ… ' + (body.message || 'è®¢é˜…å·²åˆ·æ–°'));
            } else if (status === 'warning') {
                showToast('âš ï¸ ' + (body.message || 'éƒ¨åˆ†è®¢é˜…å¤±è´¥'), 'error');
            } else {
                showToast('âŒ ' + (body.message || 'åŒæ­¥å¤±è´¥'), 'error');
            }

            applyReportToEntries(body.reports, body.synced_at, body.triggered_by);
            renderSubEntryList();
            renderSubReportPanel(body);
            updateAutoSyncStatusText(body.synced_at);
            fetchNodes();
            refreshStats();
        })
        .catch(err => {
            showToast('âŒ è¯·æ±‚å‡ºé”™: ' + err.message, 'error');
            console.error(err);
        })
        .finally(() => {
            btn.innerText = originalText;
            btn.disabled = false;
        });
    }

    function applyReportToEntries(reports, syncedAt, triggeredBy) {
        if (!Array.isArray(reports)) return;
        const fallbackTime = syncedAt || new Date().toISOString();
        reports.forEach(report => {
            const entry = SUB_ENTRIES.find(item => item.id === report.id);
            if (!entry) return;
            entry.last_status = report.status || entry.last_status;
            entry.last_message = report.message || entry.last_message;
            entry.last_synced_at = report.synced_at || fallbackTime;
            entry.last_trigger = report.trigger || triggeredBy || entry.last_trigger;
        });
    }

    function renderSubReportPanel(result) {
        const panel = document.getElementById('subReportPanel');
        if (!panel) return;
        if (!result || !Array.isArray(result.reports) || result.reports.length === 0) {
            panel.style.display = 'none';
            panel.innerHTML = '';
            return;
        }

        const statusClass = getStatusClass(result.status);
        const header = document.createElement('div');
        header.className = 'sub-report-header';
        const title = document.createElement('div');
        title.innerHTML = `<span class="status-pill ${statusClass}">${getStatusLabel(result.status)}</span> ${result.message || 'åŒæ­¥ç»“æœ'}`;
        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'btn-entry-action';
        closeBtn.textContent = 'éšè—';
        closeBtn.addEventListener('click', hideSubReportPanel);
        header.appendChild(title);
        header.appendChild(closeBtn);

        const body = document.createElement('div');
        body.className = 'sub-report-body';
        let meta = null;
        if (result.synced_at || result.triggered_by) {
            meta = document.createElement('div');
            meta.className = 'sub-report-meta';
            const timeText = result.synced_at ? (formatDateTime(result.synced_at) || 'æœªçŸ¥') : 'æœªçŸ¥';
            const triggerText = result.triggered_by ? formatTrigger(result.triggered_by) : 'æ‰‹åŠ¨æ‰§è¡Œ';
            meta.textContent = `æ—¶é—´ï¼š${timeText} ï½œ è§¦å‘ï¼š${triggerText}`;
        }

        result.reports.forEach(report => {
            const details = document.createElement('details');
            details.open = report.status !== 'success';

            const summary = document.createElement('summary');
            const label = report.alias || report.url || 'æœªå‘½åè®¢é˜…';
            const pill = document.createElement('span');
            pill.className = 'status-pill ' + getStatusClass(report.status);
            pill.textContent = getStatusLabel(report.status);
            const summaryText = document.createElement('span');
            summaryText.textContent = label;
            summary.appendChild(summaryText);
            summary.appendChild(pill);
            details.appendChild(summary);

            const info = document.createElement('div');
            info.style.fontSize = '12px';
            info.style.color = '#555';
            info.style.display = 'flex';
            info.style.flexDirection = 'column';
            info.style.gap = '4px';

            const urlLine = document.createElement('div');
            urlLine.textContent = `URLï¼š${report.url || 'æœªçŸ¥'}`;
            const msgLine = document.createElement('div');
            msgLine.textContent = `ç»“æœï¼š${report.message || '-'}`;
            const statsLine = document.createElement('div');
            statsLine.textContent = `æ–°å¢ ${report.new || 0} ï½œ æ›´æ–° ${report.updated || 0}`;
            info.appendChild(urlLine);
            info.appendChild(msgLine);
            info.appendChild(statsLine);

            if (report.synced_at || report.trigger) {
                const timeLine = document.createElement('div');
                const timeText = report.synced_at ? (formatDateTime(report.synced_at) || '') : '';
                const triggerText = report.trigger ? formatTrigger(report.trigger) : '';
                const pieces = [];
                if (timeText) {
                    pieces.push(`æ—¶é—´ï¼š${timeText}`);
                }
                if (triggerText) {
                    pieces.push(`è§¦å‘ï¼š${triggerText}`);
                }
                if (pieces.length) {
                    timeLine.textContent = pieces.join(' ï½œ ');
                    info.appendChild(timeLine);
                }
            }

            if (Array.isArray(report.errors) && report.errors.length) {
                report.errors.forEach(err => {
                    const errLine = document.createElement('div');
                    errLine.style.color = '#c62828';
                    errLine.textContent = `é”™è¯¯ï¼š${err}`;
                    info.appendChild(errLine);
                });
            }

            details.appendChild(info);
            body.appendChild(details);
        });

        panel.innerHTML = '';
        panel.appendChild(header);
        if (meta) {
            panel.appendChild(meta);
        }
        panel.appendChild(body);
        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function hideSubReportPanel() {
        const panel = document.getElementById('subReportPanel');
        if (!panel) return;
        panel.style.display = 'none';
        panel.innerHTML = '';
    }

    function addLocalNode() {
        const nameInput = document.getElementById('newNodeName');
        const protocolSelect = document.getElementById('newNodeProtocol');
        const linkInput = document.getElementById('newNodeLink');
        
        const name = nameInput.value.trim();
        const protocol = protocolSelect.value;
        const link = linkInput.value.trim();
        
        if(!name || !link || !protocol) {
            showToast('âš ï¸ è¯·å¡«å†™åç§°ã€é€‰æ‹©åè®®å¹¶è¾“å…¥é“¾æ¥', 'error');
            return;
        }

        const btn = document.querySelector('.btn-add-large');
        const originalText = btn.innerText;
        btn.innerText = 'æäº¤ä¸­...'; btn.disabled = true;

        fetch("{{ url_for('subscription.add_local_node_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, protocol: protocol, link: link })
        })
        .then(r => r.json())
        .then(res => {
            if(res.status === 'success') {
                showToast('âœ… ' + res.message);
                linkInput.value = ''; 
                fetchNodes(); 
                refreshStats();
            } else {
                showToast('âŒ æ·»åŠ å¤±è´¥: ' + res.message, 'error');
            }
        })
        .finally(() => {
            btn.innerText = originalText; btn.disabled = false;
        });
    }

    function saveNodeConfig() {
        const getIds = (id) => Array.from(document.getElementById(id).children)
            .map(el => el.dataset.uuid);
        
        const data = {
            direct: getIds('list-direct'),
            land: getIds('list-land'),
            blocked: getIds('list-blocked')
        };

        const btn = document.querySelector('#nodeManagerModal .btn-save');
        btn.innerText = 'ä¿å­˜ä¸­...';
        btn.disabled = true;

        fetch("{{ url_for('subscription.update_nodes_routing_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
            if (res.status === 'success') {
                showToast('âœ… ' + res.message);
                closeNodeManager();
                refreshStats(); 
            } else {
                showToast('âŒ ä¿å­˜å¤±è´¥: ' + res.message, 'error');
            }
        })
        .finally(() => {
            btn.innerText = 'ä¿å­˜é…ç½®';
            btn.disabled = false;
        });
    }

    function showToast(message, type = 'success') {
        const container = document.querySelector('.flash-messages');
        const alert = document.createElement('div');
        alert.className = `alert ${type}`;
        alert.innerHTML = `<span>${message}</span>`;
        container.appendChild(alert);
        setTimeout(() => {
            alert.classList.add('fade-out');
            setTimeout(() => alert.remove(), 400);
        }, 2000);
    }
    
    window.onclick = function(event) {
        if (event.target == modal) closeEditor();
        if (event.target == nodeModal) closeNodeManager();
        if (event.target == subSettingsModal) closeSubSettings();
    }
    
    // --- è®¢é˜…è®¾ç½®ç›¸å…³ JS ---
    const subSettingsModal = document.getElementById('subSettingsModal');

    function openSubSettings() {
        subSettingsModal.classList.add('active');
    }

    function closeSubSettings() {
        subSettingsModal.classList.remove('active');
    }

    // ä¿å­˜åŸŸåé…ç½®
    function saveDomainSetting() {
        const domain = document.getElementById('settingFixedDomain').value;
        const btn = document.getElementById('btnSaveDomain');
        const originalText = btn.innerText;
        btn.innerText = 'ä¿å­˜ä¸­...'; btn.disabled = true;

        fetch("{{ url_for('subscription.update_settings_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain: domain })
        })
        .then(r => r.json())
        .then(res => {
            if(res.status === 'success') {
                showToast('âœ… åœ°å€è®¾ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨åˆ·æ–°...');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('âŒ ä¿å­˜å¤±è´¥', 'error');
                btn.innerText = originalText; btn.disabled = false;
            }
        });
    }

    // æ–°å¢ï¼šä¿å­˜æ‰‹åŠ¨è¾“å…¥çš„ Token
    function saveTokenManual() {
        const token = document.getElementById('settingToken').value.trim();
        if (!token) {
            showToast('âš ï¸ Token ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }

        const btn = document.getElementById('btnSaveToken');
        const originalText = btn.innerText;
        btn.innerText = 'ä¿å­˜ä¸­...'; btn.disabled = true;

        fetch("{{ url_for('subscription.update_settings_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ api_token: token }) 
        })
        .then(r => r.json())
        .then(res => {
            if(res.status === 'success') {
                showToast('âœ… Token å·²æ›´æ–°ï¼Œæ­£åœ¨åˆ·æ–°...');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('âŒ ä¿å­˜å¤±è´¥: ' + (res.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                btn.innerText = originalText; btn.disabled = false;
            }
        });
    }

    // éšæœºåˆ·æ–° Token
    function refreshApiToken() {
        if(!confirm('âš ï¸ è­¦å‘Šï¼šåˆ·æ–° Token ä¼šå¯¼è‡´æ‰€æœ‰æ—§è®¢é˜…é“¾æ¥å¤±æ•ˆï¼\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) return;
        
        const btn = document.getElementById('btnRefreshToken');
        const originalText = btn.innerHTML;
        btn.innerHTML = '...';
        btn.disabled = true;

        fetch("{{ url_for('subscription.refresh_token_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(res => {
            if(res.status === 'success') {
                document.getElementById('settingToken').value = res.token;
                showToast('âœ… Token å·²åˆ·æ–°ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('âŒ åˆ·æ–°å¤±è´¥', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
</script>
{% endblock %}