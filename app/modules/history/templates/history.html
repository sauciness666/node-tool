{% extends 'base.html' %}

{% block title %}å†å²æµé‡ - Node Tool{% endblock %}

{% block styles %}
<style>
    /* --- å…¨å±€é¢œè‰²å®šä¹‰ --- */
    :root {
        --color-up: #34c759;    /* ä¸Šä¼  - ç»¿è‰² */
        --color-down: #007aff;  /* ä¸‹è½½ - è“è‰² */
        --color-total: #9c27b0; /* æ€»è®¡ - ç´«è‰² */
        --bg-bar: #f0f0f5;      /* è¿›åº¦æ¡èƒŒæ™¯ */
        --color-indicator: #ff3b30; /* é€‰ä¸­æŒ‡ç¤ºå™¨é¢œè‰² */
    }

    /* ğŸš¨ å…³é”®ä¿®æ”¹ï¼šå•ç‹¬è°ƒæ•´é¡¶éƒ¨å†…è¾¹è· */
    .dashboard-container {
        /* ä¸Š:0px (æ¶ˆé™¤é¡¶éƒ¨å¤šä½™ç©ºç™½), å³:20px, ä¸‹:20px, å·¦:20px */
        padding: 0 20px 20px 20px; 
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
    }

    /* --- 1. æ ‡é¢˜æ æ ·å¼ --- */
    .dashboard-title-card {
        height: 55px;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        
        /* è§†è§‰ç¾åŒ– */
        background: linear-gradient(to right, #ffffff, #f4f9ff);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03); 
        border: 1px solid #eef1f5;
        
        /* å¢åŠ é¡¶éƒ¨å¤–è¾¹è·ï¼Œé˜²æ­¢è´´é¡¶å¤ªç´§ï¼ˆå¦‚æœ padding-top è®¾ä¸º0åå¤ªè´´ï¼Œè¿™é‡Œç”¨ margin æ§åˆ¶ï¼‰ */
        margin-top: 0px; 
        margin-bottom: 25px;
        
        box-sizing: border-box;
        position: relative; 
        overflow: hidden;
    }

    .dashboard-title-card h2 {
        margin: 0;
        font-size: 21px;
        font-weight: 700;
        color: #333;
        letter-spacing: 1px;
        z-index: 2; 
        font-family: 'Segoe UI', system-ui, sans-serif;
    }

    /* èƒŒæ™¯æ°´å°è£…é¥° */
    .dashboard-title-card::after {
        content: 'ğŸ—“ï¸'; 
        position: absolute;
        right: 30px;
        bottom: -25px;
        font-size: 60px;
        opacity: 0.08; 
        transform: rotate(-15deg);
        z-index: 1;
        pointer-events: none; 
        filter: grayscale(100%);
    }

    /* --- å¸ƒå±€ç³»ç»Ÿ (CSS Grid) --- */
    .history-grid-layout {
        display: grid;
        grid-template-columns: 1fr 340px; /* å·¦ä¾§è‡ªé€‚åº”ï¼Œå³ä¾§å›ºå®šå®½åº¦ */
        gap: 20px;
        align-items: start;
    }

    .charts-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
        min-width: 0;
    }

    .list-column {
        min-width: 0;
    }

    /* --- å¡ç‰‡é€šç”¨ --- */
    .chart-card, .list-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #eee;
        position: relative;
        display: flex; 
        flex-direction: column;
    }

    /* --- åˆ—è¡¨å¡ç‰‡ (å³ä¾§ç«–é•¿æ¡) --- */
    .list-card {
        height: auto; 
        overflow: visible;
        position: sticky;
        top: 20px;
    }

    /* --- å›¾è¡¨å¡ç‰‡ --- */
    .chart-card { height: 450px; } 
    
    .chart-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f5f5f7;
        flex-wrap: wrap; gap: 15px;
    }
    .chart-title { font-size: 18px; font-weight: 700; color: #333; display: flex; align-items: center; gap: 10px; }
    .chart-subtitle { font-size: 12px; font-weight: 400; color: #999; margin-left: 5px; }
    
    .controls-group { display: flex; align-items: center; gap: 10px; }
    
    /* æ§ä»¶æ ·å¼ */
    .node-select { padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background-color: #f9f9f9; outline: none; min-width: 180px; }
    .node-select:focus { border-color: var(--color-down); background: white; }
    .date-picker { padding: 5px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; outline: none; }
    .date-picker:focus { border-color: var(--color-down); }

    .chart-wrapper { flex: 1; width: 100%; position: relative; min-height: 0; }
    #barChart, #lineChart { width: 100%; height: 100%; }

    /* --- åˆ—è¡¨éƒ¨åˆ† --- */
    .section-title {
        font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px;
        display: flex; flex-direction: column; gap: 5px;
    }

    /* è¾…åŠ©æ–‡å­—é¢œè‰²ç±» */
    .text-up { color: var(--color-up); font-weight: bold; }
    .text-down { color: var(--color-down); font-weight: bold; }
    .text-total { color: var(--color-total); font-weight: bold; font-family: monospace; }
    
    .ranking-list { 
        display: flex; flex-direction: column; gap: 0; 
        overflow-y: visible; 
        flex: 1; 
        margin: 0 -20px; 
        padding: 0 20px; 
    }

    .rank-row {
        display: flex; flex-direction: column;
        padding: 12px 10px; 
        margin: 0 -10px;    
        border-radius: 8px; 
        border-bottom: 1px dashed #eee; 
        gap: 8px;
        background: transparent; 
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
    }
    .rank-row:last-child { border-bottom: none; }
    
    .rank-row.selected { background-color: transparent !important; }

    .rank-row:hover {
        background-color: white !important; 
        transform: translateY(-3px); 
        box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        z-index: 10; 
        border-bottom-color: transparent; 
    }

    .selected-indicator {
        margin-left: 8px;
        display: inline-flex; 
        align-items: center;
        justify-content: center;
    }

    .selected-icon { display: none; font-size: 0.85em; }
    .rank-row.selected .selected-icon { display: block; }
    
    .rank-header-line { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .row-name { 
        font-size: 14px; font-weight: 600; color: #333; 
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        display: flex; align-items: center; flex-grow: 1; max-width: 80%; 
    }
    .row-value { font-family: monospace; font-size: 14px; font-weight: 700; color: #333; }
    
    .rank-details-line { display: flex; align-items: center; width: 100%; gap: 10px; }
    
    .row-bar-area { flex: 1; height: 14px; display: flex; align-items: center; position: relative; }
    
    .progress-bg { width: 100%; height: 100%; background-color: var(--bg-bar); border-radius: 7px; position: relative; overflow: hidden; display: flex; }
    .progress-container-inner { height: 100%; border-radius: 7px; overflow: hidden; display: flex; transition: width 0.6s ease; min-width: 2px; }
    .bar-up { height: 100%; background-color: var(--color-up); }
    .bar-down { height: 100%; background-color: var(--color-down); }

    .progress-ratio-text {
        position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
        font-size: 10px; color: #666; font-weight: 600; white-space: nowrap;
        text-shadow: 0 0 2px rgba(255,255,255,0.8); pointer-events: none;
    }

    /* --- Loading --- */
    .loading-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9);
        display: none; justify-content: center; align-items: center; font-size: 14px; color: #666; z-index: 50; flex-direction: column; gap: 10px;
    }
    .spinner { width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid var(--color-down); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    img.emoji { height: 1.2em; width: 1.2em; margin: 0 0.1em 0 0; vertical-align: -0.2em; }

    @media (max-width: 1200px) {
        .history-grid-layout { grid-template-columns: 1fr; }
        .list-card { height: auto; max-height: 500px; position: static; }
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <div class="dashboard-title-card">
        <h2>å†å²æµé‡</h2>
    </div>

    <div class="history-grid-layout">
        
        <div class="charts-column">
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        ğŸ“Š æ¯å°æ—¶æµé‡æ¶ˆè€—
                    </div>
                    <div class="controls-group">
                        <input type="date" id="datePicker" class="date-picker" value="{{ default_date }}" onchange="loadData()">
                    </div>
                </div>

                <div class="chart-wrapper">
                    <div id="loadingMaskBar" class="loading-overlay">
                        <div class="spinner"></div><span>åŠ è½½æ•°æ®...</span>
                    </div>
                    <div id="barChart"></div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        ğŸ“ˆ ç´¯è®¡æµé‡è¶‹åŠ¿
                        <span class="chart-subtitle">ï¼ˆå½“æ—¥ç´¯è®¡ä½¿ç”¨é‡æ›²çº¿ï¼‰</span>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <div id="loadingMaskLine" class="loading-overlay">
                        <div class="spinner"></div><span>åŠ è½½æ•°æ®...</span>
                    </div>
                    <div id="lineChart"></div>
                </div>
            </div>

        </div>

        <div class="list-column">
            <div class="list-card">
                <div class="section-title">
                    <span>ğŸ† æœ¬æ—¥å„èŠ‚ç‚¹æ’è¡Œ</span>
                    <span style="font-size: 13px; color: #666; font-weight: normal;">
                        æ€»è®¡: <span id="todayTotalDisplay" class="text-total">0.00 GB</span>
                    </span>
                </div>
                
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #999; padding-bottom: 8px; border-bottom: 1px solid #eee; margin-bottom: 5px;">
                    <span>èŠ‚ç‚¹</span>
                    <span>ç”¨é‡  </span>
                </div>
                
                <div id="rankingContainer" class="ranking-list">
                    </div>
            </div>
        </div>

    </div>

</div>
<select id="nodeSelect" style="display: none;">
    {% for node in nodes %}
    <option value="{{ node.uuid }}">{{ node.custom_name or node.name }}</option>
    {% endfor %}
</select>
{% endblock %}

{% block scripts %}
<script>
    let barChart = echarts.init(document.getElementById('barChart'));
    let lineChart = echarts.init(document.getElementById('lineChart'));
    
    const nodeSelect = document.getElementById('nodeSelect');
    const datePicker = document.getElementById('datePicker');
    
    const loadingMaskBar = document.getElementById('loadingMaskBar');
    const loadingMaskLine = document.getElementById('loadingMaskLine');
    
    const rankingContainer = document.getElementById('rankingContainer');
    const todayTotalDisplay = document.getElementById('todayTotalDisplay');

    const COLOR_UP = '#34c759';
    const COLOR_DOWN = '#007aff';
    const COLOR_TOTAL = '#9c27b0';

    // åˆå§‹é€‰ä¸­çš„ UUID
    let currentSelectedNodeUuid = nodeSelect.options.length > 0 ? nodeSelect.options[0].value : ''; 
    
    // é¦–æ¬¡åŠ è½½æ ‡è®°
    let isFirstLoad = true;

    window.addEventListener('resize', () => {
        barChart.resize();
        lineChart.resize();
    });

    function showLoading(show) {
        const display = show ? 'flex' : 'none';
        loadingMaskBar.style.display = display;
        loadingMaskLine.style.display = display;
    }

    /**
     * ä» API åŠ è½½æ•°æ®å¹¶æ¸²æŸ“å›¾è¡¨
     */
    function loadData() {
        let uuid = currentSelectedNodeUuid;
        const date = datePicker.value;
        
        // å®¹é”™ï¼šå¦‚æœå…¨å±€ UUID ä¸ºç©ºï¼Œå°è¯•å–åˆ—è¡¨ç¬¬ä¸€ä¸ª
        if (!uuid && nodeSelect.options.length > 0) {
            uuid = nodeSelect.options[0].value;
        }

        if (!uuid || !date) {
             showLoading(false);
             return;
        }

        showLoading(true);

        fetch(`{{ url_for('history.chart_data_api') }}?uuid=${uuid}&date=${date}`)
            .then(r => r.json())
            .then(res => {
                if (res.status === 'success') {
                    
                    // åªåœ¨ isFirstLoad ä¸º true æ—¶æ‰æ‰§è¡Œè‡ªåŠ¨è·³è½¬é€»è¾‘
                    if (isFirstLoad && res.data.ranking && res.data.ranking.length > 0) {
                        isFirstLoad = false; // æ ‡è®°é¦–æ¬¡åŠ è½½å·²å®Œæˆ
                        
                        const topNode = res.data.ranking[0]; 
                        // å¦‚æœå½“å‰ï¼ˆé»˜è®¤ï¼‰é€‰ä¸­çš„ä¸æ˜¯ç¬¬ä¸€åï¼Œåˆ™è·³è½¬åˆ°ç¬¬ä¸€å
                        if (uuid !== topNode.uuid) {
                             currentSelectedNodeUuid = topNode.uuid;
                             // é€’å½’è°ƒç”¨åŠ è½½æ­£ç¡®çš„æ•°æ®
                             loadData(); 
                             return; 
                        }
                    }
                    
                    // æ— è®ºæ˜¯å¦è§¦å‘è·³è½¬ï¼Œåªè¦æ•°æ®è¿”å›æˆåŠŸï¼Œå°±è§†ä¸ºåŠ è½½è¿‡ä¸€æ¬¡
                    isFirstLoad = false;

                    renderBarChart(res.data.bar);
                    renderLineChart(res.data.line);
                    renderRankingList(res.data.ranking);
                    
                    if (currentSelectedNodeUuid) {
                        highlightSelectedNode(currentSelectedNodeUuid);
                    }
                    
                } else {
                    alert('åŠ è½½å¤±è´¥: ' + res.message);
                }
            })
            .catch(e => console.error(e))
            .finally(() => showLoading(false));
    }

    function renderBarChart(data) {
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function (params) {
                    let html = `<strong>${params[0].axisValue}</strong><br/>`;
                    let sum = 0;
                    params.forEach(item => {
                        html += `${item.marker} ${item.seriesName}: <strong>${item.value}</strong> GB<br/>`;
                        sum += item.value;
                    });
                    html += `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${COLOR_TOTAL};"></span> æ€»è®¡: <strong>${sum.toFixed(4)}</strong> GB`;
                    return html;
                }
            },
            legend: { data: ['ä¸Šä¼ ', 'ä¸‹è½½'], bottom: 0 },
            grid: { left: '2%', right: '2%', bottom: '10%', top: '10%', containLabel: true },
            xAxis: {
                type: 'category', data: data.hours,
                axisLine: { lineStyle: { color: '#ccc' } }, axisLabel: { color: '#666' }
            },
            yAxis: {
                type: 'value', name: 'æ¶ˆè€— (GB)',
                splitLine: { lineStyle: { type: 'dashed', color: '#eee' } },
                axisLabel: { color: '#666' }
            },
            series: [
                {
                    name: 'ä¸Šä¼ ', type: 'bar', stack: 'total',
                    itemStyle: { color: COLOR_UP },
                    data: data.up
                },
                {
                    name: 'ä¸‹è½½', type: 'bar', stack: 'total',
                    itemStyle: { color: COLOR_DOWN },
                    data: data.down
                }
            ]
        };
        barChart.setOption(option, true);
    }

    function renderLineChart(data) {
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                formatter: function (params) {
                    let html = `<strong>${params[0].axisValue}</strong><br/>`;
                    params.forEach(item => {
                        html += `${item.marker} ${item.seriesName}: <strong>${item.value}</strong> GB<br/>`;
                    });
                    return html;
                }
            },
            legend: { 
                data: ['ä¸Šä¼ ', 'ä¸‹è½½', 'æ€»æµé‡'], 
                bottom: 0 
            },
            grid: { left: '2%', right: '2%', bottom: '10%', top: '10%', containLabel: true },
            xAxis: {
                type: 'category', boundaryGap: false, data: data.times,
                axisLine: { lineStyle: { color: '#ccc' } }, axisLabel: { color: '#666' }
            },
            yAxis: {
                type: 'value', name: 'ç´¯è®¡ (GB)',
                splitLine: { lineStyle: { type: 'dashed', color: '#eee' } },
                axisLabel: { color: '#666' }
            },
            series: [
                {
                    name: 'ä¸Šä¼ ', type: 'line', smooth: true, symbol: 'none',
                    itemStyle: { color: COLOR_UP },
                    areaStyle: { opacity: 0.1, color: COLOR_UP },
                    lineStyle: { width: 2 },
                    data: data.uploads
                },
                {
                    name: 'ä¸‹è½½', type: 'line', smooth: true, symbol: 'none',
                    itemStyle: { color: COLOR_DOWN },
                    areaStyle: { opacity: 0.1, color: COLOR_DOWN },
                    lineStyle: { width: 2 },
                    data: data.downloads
                },
                {
                    name: 'æ€»æµé‡', type: 'line', smooth: true, symbol: 'none',
                    itemStyle: { color: COLOR_TOTAL },
                    areaStyle: { opacity: 0.05, color: COLOR_TOTAL }, 
                    lineStyle: { width: 3 },
                    data: data.totals
                }
            ]
        };
        lineChart.setOption(option, true);
    }

    function renderRankingList(data) {
        rankingContainer.innerHTML = '';
        
        if (!data || data.length === 0) {
            rankingContainer.innerHTML = '<div style="color:#999; padding:20px; text-align:center;">æš‚æ— æ•°æ®</div>';
            todayTotalDisplay.innerText = "0.00 GB";
            return;
        }

        let totalUsage = 0;
        data.forEach(item => totalUsage += item.usage);
        todayTotalDisplay.innerText = totalUsage.toFixed(2) + " GB";

        const avgUsage = totalUsage / data.length;
        const scaleMax = avgUsage > 0 ? (avgUsage * 2) : 1; 

        data.forEach(item => {
            let totalPercent = (item.usage / scaleMax) * 100;
            if (totalPercent > 100) totalPercent = 100;

            let upPercent = 0;
            let downPercent = 0;
            let ratioText = "-";
            
            if (item.usage > 0) {
                upPercent = (item.up / item.usage) * 100;
                downPercent = (item.down / item.usage) * 100;
                
                if (item.down > 0) ratioText = (item.up / item.down).toFixed(2);
                else ratioText = "âˆ"; 
            }

            let flag = (item.region || '').replace(/\s/g, '');
            if (!flag) flag = 'ğŸŒ';
            
            const itemUuid = item.uuid || ''; 

            const html = `
                <div class="rank-row" onclick="selectNodeByUuid('${itemUuid}')" data-uuid="${itemUuid}" title="${item.name}">
                    <div class="rank-header-line">
                        <div class="row-name">
                            <span style="margin-right: 4px;">${flag}</span>
                            <span>${item.name}</span>
                            <span class="selected-indicator">
                                <span class="selected-icon">âœ…</span>
                            </span>
                        </div>
                        <div class="row-value">${item.usage.toFixed(2)} G</div>
                    </div>
                    
                    <div class="rank-details-line">
                        <div class="row-bar-area">
                            <div class="progress-bg">
                                <div class="progress-container-inner" style="width: ${totalPercent}%;">
                                    <div class="bar-up" style="width: ${upPercent}%;" title="ä¸Šä¼ : ${item.up.toFixed(2)} GB"></div>
                                    <div class="bar-down" style="width: ${downPercent}%;" title="ä¸‹è½½: ${item.down.toFixed(2)} GB"></div>
                                </div>
                                <div class="progress-ratio-text">${ratioText}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            rankingContainer.insertAdjacentHTML('beforeend', html);
        });

        twemoji.parse(rankingContainer, { folder: 'svg', ext: '.svg' });
    }

    function highlightSelectedNode(uuid) {
        document.querySelectorAll('.rank-row.selected').forEach(row => {
            row.classList.remove('selected');
        });

        const selectedRow = document.querySelector(`.rank-row[data-uuid="${uuid}"]`);
        if (selectedRow) {
            selectedRow.classList.add('selected');
        }
    }

    function selectNodeByUuid(uuid) {
        if (!uuid) return;
        nodeSelect.value = uuid;
        currentSelectedNodeUuid = uuid;
        loadData();
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (nodeSelect.options.length > 0) {
             loadData();
        }
    });
</script>
{% endblock %}