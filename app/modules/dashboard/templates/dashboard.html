{% extends 'base.html' %}

{% block title %}ä»ªè¡¨ç›˜ - Node Tool{% endblock %}

{% block styles %}
<style>
    /* ===========================
       1. Toast æç¤ºæ¡†æ ·å¼ (ä¿æŒä¸å˜)
       =========================== */
    .flash-messages { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; align-items: center; width: auto; }
    .alert { position: relative; width: fit-content; min-width: 130px; white-space: nowrap; padding: 14px 14px; background: #fff; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 0 1px rgba(0,0,0,0.1); font-size: 15px; color: #333; font-weight: 500; display: flex; align-items: center; justify-content: center; opacity: 0; transform: translateY(-20px); animation: slideDownFade 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .alert.success { border-left: 5px solid #34c759; }
    .alert.success::before { content: 'âœ”'; display: inline-flex; width: 24px; height: 24px; margin-right: 12px; background: rgba(52, 199, 89, 0.1); color: #34c759; border-radius: 50%; align-items: center; justify-content: center; font-size: 14px; }
    .alert.error { border-left: 5px solid #d74242; }
    .alert.error::before { content: 'âœ•'; display: inline-flex; width: 24px; height: 24px; margin-right: 12px; background: rgba(255, 59, 48, 0.1); color: #d74242; border-radius: 50%; align-items: center; justify-content: center; font-size: 14px; }
    .alert.info { border-left: 5px solid #007aff; } 
    .alert.info::before { content: 'â“˜'; display: inline-flex; width: 24px; height: 24px; margin-right: 12px; background: rgba(0, 122, 255, 0.1); color: #007aff; border-radius: 50%; align-items: center; justify-content: center; font-size: 14px; }
    @keyframes slideDownFade { from { opacity: 0; transform: translateY(-20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .fade-out { transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); opacity: 0 !important; transform: translateY(-20px) !important; }
    
    /* ===========================
       2. ä»ªè¡¨ç›˜å¸ƒå±€æ ·å¼ 
       =========================== */
    .dashboard-container {
        padding: 20px;
        box-sizing: border-box;
    }

    /* ğŸš¨ ä¿®æ”¹ï¼šé«˜åº¦è°ƒæ•´ä¸º 50pxï¼Œå¹¶ç§»é™¤äº†å·¦ä¾§è¾¹æ¡† */
    .dashboard-title-card {
        height: 55px; /* ä¿®æ”¹ï¼šå›ºå®šé«˜åº¦ä¸º 50px */
        width: 100%;
        display: flex;
        align-items: center; /* å‚ç›´å±…ä¸­ */
        justify-content: center; /* æ°´å¹³å±…ä¸­ */
        
        /* è§†è§‰ç¾åŒ– */
        background: linear-gradient(to right, #ffffff, #f4f9ff); /* ä¿æŒå¾®å¦™çš„è“ç™½æ¸å˜ */
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03); 
        border: 1px solid #eef1f5;
        /* border-left: 6px solid #007aff;  <-- å·²ç§»é™¤æ­¤è¡Œ */
        
        margin-bottom: 30px;
        box-sizing: border-box;
        position: relative; 
        overflow: hidden;
    }

    /* æ ‡é¢˜æ–‡å­—æ ·å¼ */
    .dashboard-title-card h2 {
        margin: 0;
        font-size: 21px; /* ç¨å¾®è°ƒå°å­—ä½“ä»¥é€‚é… 50px é«˜åº¦ */
        font-weight: 700;
        color: #333;
        letter-spacing: 1px;
        z-index: 2; 
        font-family: 'Segoe UI', system-ui, sans-serif;
    }

    /* èƒŒæ™¯æ°´å°è£…é¥° */
    .dashboard-title-card::after {
        content: 'ğŸ“Š'; 
        position: absolute;
        right: 30px;
        bottom: -25px; /* è°ƒæ•´ä½ç½®ä»¥é€‚åº”è¾ƒçŸ®çš„å¡ç‰‡ */
        font-size: 60px; /* ç¨å¾®è°ƒå°å›¾æ ‡ */
        opacity: 0.08; 
        transform: rotate(-15deg);
        z-index: 1;
        pointer-events: none; 
        filter: grayscale(100%);
    }

    /* èŠ‚ç‚¹åˆ—è¡¨å¤´éƒ¨è¡Œ */
    .nodes-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    /* ... (å…¶ä½™æ ·å¼ä¿æŒä¸å˜) ... */
    .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
    
    .summary-card { 
        padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); background: white; border: 1px solid #eee; 
        position: relative; display: flex; flex-direction: column; 
        min-height: 160px; 
    }
    
    .summary-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
    .summary-header p { margin: 0; font-size: 14px; color: #86868b; font-weight: 500; }
    .summary-icon { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; color: white; margin-left: 10px; }
    .color-blue { background-color: #007aff; }
    .color-green { background-color: #34c759; }
    .color-red { background-color: #d74242; }

    .summary-center-box { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; }
    .summary-card h4 { font-size: 36px; font-weight: 700; color: #333; margin: 0; line-height: 1; }

    .komari-link-btn { position: absolute; bottom: 15px; right: 15px; padding: 0 12px; height: 32px; background: #f0f7ff; color: #007aff; border-radius: 8px; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: all 0.2s; font-size: 13px; font-weight: 600; gap: 5px; }
    .komari-link-btn:hover { background: #007aff; color: white; }

    .traffic-card-content { flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; margin-bottom: 10px; }
    .traffic-progress-wrapper { width: 100%; margin-top: auto; }
    .limit-text-top { text-align: right; font-size: 12px; color: #86868b; margin-bottom: 6px; font-weight: 500; width: 100%; }
    .progress-bar-thick-container { width: 100%; height: 24px; background-color: #f0f0f5; border-radius: 12px; overflow: hidden; position: relative; }
    .progress-bar-thick { height: 100%; background-color: #34c759; border-radius: 12px; transition: width 0.4s ease-in-out; }
    .progress-text-centered { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: #333; text-shadow: 0 0 2px rgba(255,255,255,0.8); z-index: 2; }

    .rank-list { margin-top: 10px; width: 100%; }
    .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px dashed #f0f0f0; font-size: 13px; }
    .rank-item:last-child { border-bottom: none; }
    .rank-badge { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; color: white; font-size: 10px; font-weight: 700; margin-right: 8px; font-family: "Times New Roman", serif; }
    .rank-1 { background-color: #d32f2f; }
    .rank-2 { background-color: #e53935; }
    .rank-3 { background-color: #ef5350; }
    .rank-4 { background-color: #e57373; }
    .rank-5 { background-color: #ef9a9a; }
    .rank-name { font-weight: 500; color: #333; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; }
    .rank-traffic { font-weight: 600; color: #007aff; font-family: monospace; }
    
    .nodes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .node-card { padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); background: white; transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; position: relative; border: 1px solid transparent; }
    .node-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); border-color: #007aff; }
    .node-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .node-header h3 { margin: 0; font-size: 18px; font-weight: 600; font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'sans-serif'; }
    
    .badges-container { display: flex; gap: 6px; align-items: center; }
    .badge { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 12px; display: inline-block; }
    .badge-direct { background-color: #e8f5e9; color: #2e7d32; } 
    .badge-landing { background-color: #fffde7; color: #fbc02d; } 
    .badge-gray { background-color: #f5f5f7; color: #666; } 
    .badge-warning { background-color: #fff3e0; color: #ef6c00; }
    .badge-expired { background-color: #ffebee; color: #c62828; }
    .badge-count { background-color: #f3e5f5; color: #7b1fa2; }
    .badge-blocked { background-color: #ffebee; color: #c62828; }
    
    img.emoji { height: 1.2em; width: 1.2em; margin: 0 0.15em 0 0.05em; vertical-align: -0.2em; }

    .node-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 13px; color: #666; margin-bottom: 15px;}
    .stat-item { display: flex; flex-direction: column; }
    .stat-item strong { margin-bottom: 3px; font-weight: 600; color: #333; }
    .align-center { text-align: center; }
    .align-right { text-align: right; }
    .node-progress-wrapper { margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0; }
    .node-progress-row { margin-bottom: 8px; }
    .node-progress-row:last-child { margin-bottom: 0; }
    .node-progress-text { display: flex; justify-content: space-between; font-size: 12px; color: #86868b; margin-bottom: 3px; }
    .progress-bar-container { width: 100%; height: 8px; background-color: #f5f5f7; border-radius: 4px; margin-top: 5px; overflow: hidden; }
    .progress-bar { height: 100%; background-color: #34c759; border-radius: 4px; transition: width 0.4s ease-in-out; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(3px); opacity: 0; transition: opacity 0.3s ease; }
    .modal-overlay.active { display: flex; opacity: 1; }
    .modal-box { background: white; width: 600px; padding: 30px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s ease; position: relative; max-height: 90vh; overflow-y: auto; }
    .modal-overlay.active .modal-box { transform: scale(1); }
    .modal-title-bar { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 15px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
    .close-btn { cursor: pointer; font-size: 28px; color: #86868b; line-height: 1; margin-left: 15px; }
    .title-edit-wrapper { flex: 1; display: flex; flex-direction: column; }
    .title-display { font-size: 22px; font-weight: 700; color: #1d1d1f; padding: 4px 8px; margin-left: -8px; border-radius: 6px; border: 1px solid transparent; cursor: text; transition: all 0.2s; min-height: 34px; }
    .title-display:hover { background: #f5f5f7; }
    .title-input { display: none; font-size: 22px; font-weight: 700; color: #1d1d1f; padding: 4px 8px; margin-left: -8px; border-radius: 6px; border: 1px solid #007aff; background: #fff; width: 100%; outline: none; font-family: inherit; box-sizing: border-box; }
    .modal-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
    
    .switch-group { display: flex; align-items: center; gap: 12px; }
    .switch-group > label { font-size: 14px; font-weight: 600; color: #333; margin: 0; }
    
    .segmented-control { display: flex; border-radius: 8px; background: #f5f5f7; padding: 3px; gap: 3px; height: 36px; box-sizing: border-box; }
    .segmented-control input[type="radio"] { display: none; }
    .segmented-control label { flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; font-weight: 500; border-radius: 6px; transition: all 0.2s; padding: 0 12px; height: 100%; box-sizing: border-box; color: #666; margin: 0; min-width: 50px; }
    .segmented-control input[type="radio"]:checked + label { background: white; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); font-weight: 600; }
    #routing0:checked + label { color: #34c759; }
    #routing1:checked + label { color: #ff9f0a; }
    #routing-1:checked + label { color: #d74242; }

    .expiry-wrapper { display: flex; align-items: center; gap: 8px; background: #f9f9f9; padding: 8px 12px; border-radius: 8px; border: 1px solid #eee; }
    .expiry-label { font-size: 14px; font-weight: 600; color: #333; }
    .expiry-value { font-size: 14px; font-family: monospace; font-weight: 500; color: #555; }
    .modal-field { margin-bottom: 15px; }
    .modal-field label { display: block; font-size: 14px; font-weight: 600; color: #333; margin-bottom: 8px; }
    .link-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; height: 40px; }
    .protocol-select { width: 120px; height: 100%; padding: 0 10px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; font-size: 13px; color: #333; flex-shrink: 0; box-sizing: border-box; margin: 0; }
    .protocol-select:focus { border-color: #007aff; outline: none; }
    .link-input { flex: 1; height: 100%; padding: 0 12px; border: 1px solid #ddd; border-radius: 8px; background: #fff; font-family: monospace; font-size: 13px; color: #555; box-sizing: border-box; margin: 0; transition: border 0.2s; }
    .link-input:focus { border-color: #007aff; outline: none; }
    .btn-remove { width: 40px; height: 100%; border: 1px solid #ffccd0; background: #fff0f1; color: #d74242; border-radius: 8px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s; box-sizing: border-box; margin: 0; }
    .btn-remove:hover { background: #ffebee; border-color: #ffb3b9; }
    .btn-add { width: 100%; padding: 10px; border: 1px dashed #007aff; background: #f0f7ff; color: #007aff; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s; }
    .btn-add:hover { background: #e0efff; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; pt: 20px; border-top: 1px solid #eee; }
    .btn-save { background: #007aff; color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: background 0.2s; }
    .btn-save:hover { background: #0062cc; }
    .btn-delete { background: #fff0f1; color: #d74242; border: 1px solid #ffccd0; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s; }
    .btn-delete:hover { background: #ffebee; border-color: #ffb3b9; }
    .btn-delete.confirm { background: #d74242; color: white; border-color: #d74242; animation: shake 0.3s ease-in-out; }
    @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
</style>
{% endblock %}

{% block content %}
<div class="flash-messages"></div>

<div class="dashboard-container">
    
    <div class="dashboard-title-card">
        <h2>ä»ªè¡¨ç›˜</h2>
    </div>

    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-header"><p>æ€»æœåŠ¡å™¨èŠ‚ç‚¹æ•°é‡</p><span class="summary-icon color-blue">N</span></div>
            <div class="summary-center-box">
                <h4 style="margin-top: -25px;">{{ summary.total_nodes | default(0) }}</h4>
            </div>
            <a href="{{ komari_url }}" target="_blank" class="komari-link-btn" title="å‰å¾€ Komari">
                ğŸ”— Komari
            </a>
        </div>
        
        {% set total_limit_bytes = summary.total_traffic_limit | default(0) %}
        {% set total_consumed_bytes = summary.total_consumed_traffic | default(0) %}
        <div class="summary-card">
            <div class="summary-header"><p>æ‰€æœ‰æœåŠ¡å™¨æ€»æ¶ˆè€—æµé‡</p><span class="summary-icon color-green">âˆ‘</span></div>
            
            <div class="traffic-card-content">
                {% set total_limit_gb = (total_limit_bytes / 1024 / 1024 / 1024) | round(2) %}
                {% set total_consumed_gb = (total_consumed_bytes / 1024 / 1024 / 1024) | round(2) %}
                <h4>{{ total_consumed_gb }} GB</h4>
            </div>
            
            {% set progress_percent = 0 %}
            {% if total_limit_bytes > 0 %}
                {% set progress_percent = (total_consumed_bytes * 100 / total_limit_bytes) | round(1) %}
            {% endif %}
            
            <div class="traffic-progress-wrapper">
                <div class="limit-text-top">æ€»é™é¢ï¼š{{ total_limit_gb }} GB</div>
                <div class="progress-bar-thick-container">
                    <div class="progress-bar-thick" style="width: {{ progress_percent }}%;"></div>
                    <div class="progress-text-centered">å·²ä½¿ç”¨ {{ progress_percent }}%</div>
                </div>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-header"><p style="margin-bottom: 10px;">æµé‡æ¶ˆè€—æ’å (Top 5)</p><span class="summary-icon color-red">T</span></div>
            <div class="rank-list">
                {% set roman_numerals = ["â… ", "â…¡", "â…¢", "â…£", "â…¤"] %}
                {% for rank_item in summary.top_traffic_nodes %} 
                    {% set rank_traffic_gb = (rank_item.traffic | default(0) / 1024 / 1024 / 1024) | round(2) %}
                    <div class="rank-item">
                        <div style="display: flex; align-items: center; flex: 1; overflow: hidden;">
                            <span class="rank-badge rank-{{ loop.index }}">{{ roman_numerals[loop.index0] }}</span>
                            <span class="rank-name">{{ rank_item.name }}</span>
                        </div>
                        <span class="rank-traffic">{{ rank_traffic_gb }} GB</span>
                    </div>
                {% else %}
                     <div class="rank-item" style="border-bottom: none; justify-content: center; color: #86868b;">æš‚æ— æµé‡æ•°æ®</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="nodes-header-row">
        <h3 style="margin: 0;">æœåŠ¡å™¨è¯¦ç»†çŠ¶æ€ ({{ nodes|length }})</h3>
        <button id="refreshBtn" class="btn btn-primary" style="width: auto; background-color: #007aff; border-color: #007aff; padding: 6px 16px; font-size: 14px;">
            è·å–æœ€æ–°æ•°æ®
        </button>
    </div>

    {% if nodes %}
        <div class="nodes-grid">
            {% for node, history in nodes %}
            {% set history_data = history if history is not none else {} %}
            {% set links = node.get_links_dict() %}
            
            {# è®¡ç®—æœ‰æ•ˆé“¾æ¥æ•°é‡ #}
            {% set link_count = links.values() | select | list | length %}
            
            {% set days_text = "é•¿æœŸ" %}
            {% set days_class = "badge-gray" %}
            {% if node.expired_at %}
                {% set delta = node.expired_at - now %}
                {% set remaining_days = delta.days %}
                {% if remaining_days > 999 %}
                    {% set days_text = "é•¿æœŸ" %}
                {% elif remaining_days < 0 %}
                    {% set days_text = "è¿‡æœŸ" %}
                    {% set days_class = "badge-expired" %}
                {% else %}
                    {% set days_text = remaining_days ~ " å¤©" %}
                    {% if remaining_days < 7 %}{% set days_class = "badge-warning" %}{% endif %}
                {% endif %}
            {% endif %}

            {% set route_text = "ç›´è¿" %}
            {% set route_class = "badge-direct" %} 
            {% if node.routing_type == 1 %}
                {% set route_text = "è½åœ°" %}
                {% set route_class = "badge-landing" %} 
            {# å¤„ç† routing_type == -1 (å±è”½) #}
            {% elif node.routing_type == -1 %}
                {% set route_text = "å±è”½" %}
                {% set route_class = "badge-blocked" %} 
            {% endif %}

            {% set node_consumed = (history_data.total_up | default(0)) + (history_data.total_down | default(0)) %}
            {% set node_limit = node.traffic_limit | default(0) %}
            {% set node_percent = 0 %}
            {% if node_limit > 0 %}
                {% set node_percent = (node_consumed * 100 / node_limit) | round(1) %}
                {% if node_percent > 100 %}{% set node_percent = 100 %}{% endif %}
            {% endif %}
            
            {% set cpu_usage = history_data.cpu_usage | default(0) | round(0) %}

            <div class="node-card" 
                 onclick="openNodeModal(this)"
                 data-uuid="{{ node.uuid }}"
                 data-name="{{ node.name }}" 
                 data-custom="{{ node.custom_name }}"
                 data-expiry="{{ node.expired_at.strftime('%Y-%m-%d %H:%M') if node.expired_at else 'æ— é™æœŸ' }}"
                 data-routing="{{ node.routing_type | default(0) }}"
                 data-links='{{ links | tojson | safe }}'>
                
                <div class="node-header">
                    <h3>{{ (node.region | flag | replace(' ', '') | trim) or 'ğŸŒ' }}&nbsp;{{ node.custom_name or node.name }}</h3>
                    
                    <div class="badges-container">
                        {# åè®®é“¾æ¥æ•°é‡æ˜¾ç¤º #}
                        <span class="badge badge-count">{{ link_count }} åè®®</span>
                        
                        {# ç±»å‹å¾½ç«  #}
                        <span class="badge {{ route_class }}">{{ route_text }}</span>
                        {# åˆ°æœŸæ—¶é—´å¾½ç«  #}
                        <span class="badge {{ days_class }}">{{ days_text }}</span>
                    </div>
                </div>

                <div class="node-stats">
                    <div class="stat-item">
                        <strong>ä¸Šä¼ </strong>
                        <span>{{ (history_data.total_up | default(0) / 1024 / 1024 / 1024) | round(2) }} GB</span>
                    </div>
                    <div class="stat-item align-center">
                        <strong>ä¸‹è½½</strong>
                        <span>{{ (history_data.total_down | default(0) / 1024 / 1024 / 1024) | round(2) }} GB</span>
                    </div>
                    <div class="stat-item align-center">
                        <strong>æ€»æµé‡</strong>
                        <span>{{ (node_consumed / 1024 / 1024 / 1024) | round(2) }} GB</span>
                    </div>
                    <div class="stat-item align-right">
                        <strong>é™é¢</strong>
                        <span>{{ (node.traffic_limit | default(0) / 1024 / 1024 / 1024) | round(2) }} GB</span>
                    </div>
                </div>

                <div class="node-progress-wrapper">
                    <div class="node-progress-row">
                        <div class="node-progress-text"><span>æµé‡</span><span>{{ node_percent }}%</span></div>
                        <div class="progress-bar-container" style="height: 6px; margin-top: 0;">
                            <div class="progress-bar" style="width: {{ node_percent }}%; background-color: {% if node_percent > 90 %}#d74242{% elif node_percent > 70 %}#ff9f0a{% else %}#34c759{% endif %};"></div>
                        </div>
                    </div>
                    <div class="node-progress-row">
                        <div class="node-progress-text"><span>è´Ÿè½½</span><span>{{ cpu_usage }}%</span></div>
                        <div class="progress-bar-container" style="height: 6px; margin-top: 0;">
                            <div class="progress-bar" style="width: {{ cpu_usage }}%; background-color: {% if cpu_usage > 80 %}#d74242{% elif cpu_usage > 50 %}#ff9f0a{% else %}#007aff{% endif %};"></div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card shadow" style="text-align: center; color: #86868b;">
            <p style="margin: 30px 0;">æš‚æ— èŠ‚ç‚¹æ•°æ®ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®å°è¯•åŒæ­¥ã€‚</p>
        </div>
    {% endif %}
</div>

<div id="nodeModal" class="modal-overlay">
    <div class="modal-box" onclick="event.stopPropagation()">
        <div class="modal-title-bar">
            <div class="title-edit-wrapper">
                <div id="modalNodeNameDisplay" class="title-display" onclick="enableNameEdit()"></div>
                <input type="text" id="modalNodeNameInput" class="title-input" onblur="disableNameEdit()" onkeydown="handleNameEnter(event)">
            </div>
            <span class="close-btn" onclick="closeNodeModal()">Ã—</span>
        </div>
        <input type="hidden" id="modalUuid">
        <div class="modal-header-row">
            
            <div class="switch-group">
                <label>è·¯ç”±ç±»å‹</label>
                <div class="segmented-control" id="routingControl">
                    <input type="radio" id="routing0" name="routing_type" value="0">
                    <label for="routing0">ç›´è¿</label>
                    
                    <input type="radio" id="routing1" name="routing_type" value="1">
                    <label for="routing1">è½åœ°</label>
                    
                    <input type="radio" id="routing-1" name="routing_type" value="-1">
                    <label for="routing-1">å±è”½</label>
                </div>
            </div>
            
            <div class="expiry-wrapper">
                <span class="expiry-label">åˆ°æœŸæ—¶é—´ï¼š</span>
                <span class="expiry-value" id="modalExpiry"></span>
            </div>
        </div>
        <div class="modal-field">
            <label>èŠ‚ç‚¹é“¾æ¥</label>
            <div id="linksContainer"></div>
            <button class="btn-add" onclick="addLinkRow()">+ æ·»åŠ åè®®</button>
        </div>
        <div class="modal-actions">
            <button class="btn-delete" onclick="deleteNode()" id="btnDelete">åˆ é™¤èŠ‚ç‚¹</button>
            <button class="btn-save" onclick="saveNodeDetails()">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>

<script>
    // ğŸš¨ ç§»é™¤æ—§çš„ modalRoutingSwitch å’Œ switchLabel å˜é‡
    const refreshBtn = document.getElementById('refreshBtn');
    const modalOverlay = document.getElementById('nodeModal');
    const linksContainer = document.getElementById('linksContainer');
    const btnDelete = document.getElementById('btnDelete');

    // ğŸš¨ ä¿®æ­£ï¼šä½¿ç”¨æœ¬åœ°å®šä¹‰çš„ .dashboard-container ä»£æ›¿ .container-fluid
    const PROTOCOLS = [
        { val: 'hy2', name: 'Hysteria2' },
        { val: 'vless', name: 'Vless' },
        { val: 'ss', name: 'Shadowsocks' },
        { val: 'tuic', name: 'Tuic' },
        { val: 'socks5', name: 'Socks5' }
    ];

    let deleteConfirmState = false;

    // å¯ç”¨åç§°ç¼–è¾‘
    function enableNameEdit() {
        const display = document.getElementById('modalNodeNameDisplay');
        const input = document.getElementById('modalNodeNameInput');
        display.style.display = 'none';
        input.style.display = 'block';
        input.focus();
    }

    // ç¦ç”¨åç§°ç¼–è¾‘ï¼ˆä¿å­˜ï¼‰
    function disableNameEdit() {
        const display = document.getElementById('modalNodeNameDisplay');
        const input = document.getElementById('modalNodeNameInput');
        const newValue = input.value.trim();
        if (newValue) { display.innerText = newValue; }
        input.style.display = 'none';
        display.style.display = 'block';
    }

    // å›è½¦ä¿å­˜åç§°
    function handleNameEnter(event) {
        if (event.key === 'Enter') { disableNameEdit(); }
    }

    // æ‰“å¼€æ¨¡æ€æ¡†å¹¶å¡«å……æ•°æ®
    function openNodeModal(card) {
        const uuid = card.getAttribute('data-uuid');
        const name = card.getAttribute('data-name');
        const customName = card.getAttribute('data-custom'); 
        const expiry = card.getAttribute('data-expiry');
        
        // ğŸš¨ ä¿®æ­£ï¼šä»å­—ç¬¦ä¸²ä¸­è·å– routing å¿…é¡»è½¬æ¢ä¸ºæ•°å­—
        const routing = parseInt(card.getAttribute('data-routing'), 10);
        
        let links = {};
        try { links = JSON.parse(card.getAttribute('data-links')); } catch(e) {}

        document.getElementById('modalUuid').value = uuid;
        const displayName = customName || name;
        document.getElementById('modalNodeNameDisplay').innerText = displayName;
        document.getElementById('modalNodeNameInput').value = displayName;
        document.getElementById('modalNodeNameDisplay').style.display = 'block';
        document.getElementById('modalNodeNameInput').style.display = 'none';
        document.getElementById('modalExpiry').innerText = expiry;
        
        // ğŸš¨ å…³é”®ä¿®æ”¹ï¼šæ ¹æ® routing å€¼é€‰æ‹©å¯¹åº”çš„ radio button
        // ç¡®ä¿ routing ä¸º -1, 0, æˆ– 1
        const routeValue = [0, 1, -1].includes(routing) ? routing : 0;
        const radioElement = document.getElementById(`routing${routeValue}`);
        if (radioElement) {
            radioElement.checked = true;
        }

        renderLinks(links);
        
        deleteConfirmState = false;
        btnDelete.innerText = "åˆ é™¤èŠ‚ç‚¹";
        btnDelete.classList.remove('confirm');

        modalOverlay.classList.add('active');
    }

    // æ¸²æŸ“åè®®é“¾æ¥åˆ—è¡¨
    function renderLinks(linksData) {
        linksContainer.innerHTML = ''; 
        for (const [proto, link] of Object.entries(linksData)) {
            const isKnownProtocol = PROTOCOLS.some(p => p.val === proto);
            if (isKnownProtocol) {
                addLinkRow(proto, link);
            }
        }
    }

    // æ·»åŠ ä¸€è¡Œåè®®è¾“å…¥æ¡†
    function addLinkRow(selectedProto = PROTOCOLS[0].val, linkValue = '') {
        const div = document.createElement('div');
        div.className = 'link-row';
        
        const select = document.createElement('select');
        select.className = 'protocol-select';
        PROTOCOLS.forEach(p => {
            const option = document.createElement('option');
            option.value = p.val;
            option.text = p.name;
            if (p.val === selectedProto) option.selected = true;
            select.appendChild(option);
        });

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'link-input';
        input.value = linkValue;

        const btn = document.createElement('button');
        btn.className = 'btn-remove';
        btn.innerHTML = 'Ã—';
        btn.onclick = function() { div.remove(); };

        div.appendChild(select);
        div.appendChild(input);
        div.appendChild(btn);
        linksContainer.appendChild(div);
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeNodeModal() {
        modalOverlay.classList.remove('active');
    }

    modalOverlay.addEventListener('click', function(e) {
        if (e.target === this) closeNodeModal();
    });

    // åˆ é™¤èŠ‚ç‚¹
    function deleteNode() {
        if (!deleteConfirmState) {
            deleteConfirmState = true;
            btnDelete.innerText = "ç¡®è®¤åˆ é™¤ï¼";
            btnDelete.classList.add('confirm');
            return;
        }

        const uuid = document.getElementById('modalUuid').value;
        btnDelete.disabled = true;
        btnDelete.innerText = "åˆ é™¤ä¸­...";

        fetch("{{ url_for('dashboard.delete_node_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uuid: uuid })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast('ğŸ—‘ï¸ èŠ‚ç‚¹å·²åˆ é™¤');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('âŒ åˆ é™¤å¤±è´¥: ' + data.message, 'error');
                deleteConfirmState = false;
                btnDelete.innerText = "åˆ é™¤èŠ‚ç‚¹";
                btnDelete.classList.remove('confirm');
                btnDelete.disabled = false;
            }
        })
        .catch(error => {
            console.error(error);
            showToast('âŒ è¯·æ±‚é”™è¯¯', 'error');
            btnDelete.disabled = false;
        });
    }

    // ä¿å­˜èŠ‚ç‚¹ä¿¡æ¯
    function saveNodeDetails() {
        const uuid = document.getElementById('modalUuid').value;
        let customName = document.getElementById('modalNodeNameInput').value.trim();
        
        // ğŸš¨ å…³é”®ä¿®æ”¹ï¼šè·å–é€‰ä¸­çš„è·¯ç”±ç±»å‹çš„å€¼
        const selectedRoutingRadio = document.querySelector('input[name="routing_type"]:checked');
        // è½¬æ¢ä¸ºæ•°å­—ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™é»˜è®¤ç»™ 0 (ç›´è¿)
        const routingType = selectedRoutingRadio ? parseInt(selectedRoutingRadio.value, 10) : 0;
        
        const links = {};
        const rows = linksContainer.querySelectorAll('.link-row');
        rows.forEach(row => {
            const proto = row.querySelector('.protocol-select').value;
            const link = row.querySelector('.link-input').value.trim();
            if (link) { links[proto] = link; }
        });

        const btn = document.querySelector('.btn-save');
        btn.innerText = 'ä¿å­˜ä¸­...';
        btn.disabled = true;

        // æ„å»ºè¯·æ±‚ä½“ï¼ŒåŒ…å«é€‰ä¸­çš„ routing_type
        const requestBody = {
            uuid: uuid,
            links: links,
            custom_name: customName,
            // ğŸš¨ å‘é€é€‰ä¸­çš„å€¼ (-1, 0, æˆ– 1)
            routing_type: routingType 
        };

        fetch("{{ url_for('dashboard.update_node_api') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast('âœ… èŠ‚ç‚¹ä¿¡æ¯å·²æ›´æ–°ï¼');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('âŒ æ›´æ–°å¤±è´¥: ' + data.message, 'error');
                btn.innerText = 'ä¿å­˜ä¿®æ”¹';
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('âŒ è¯·æ±‚é”™è¯¯', 'error');
            btn.innerText = 'ä¿å­˜ä¿®æ”¹';
            btn.disabled = false;
        });
    }

    // æ˜¾ç¤º Toast æç¤º
    function showToast(message, type = 'success', duration = 3000) {
        const container = document.querySelector('.flash-messages');
        const alert = document.createElement('div');
        alert.className = `alert ${type}`;
        alert.innerHTML = `<span>${message}</span>`;
        container.appendChild(alert);
        if (duration > 0) {
            setTimeout(() => { alert.classList.add('fade-out'); setTimeout(() => alert.remove(), 400); }, duration);
        }
        return alert; 
    }

    // æ‰‹åŠ¨è§¦å‘åˆ·æ–°
    function triggerRefresh() {
        const originalText = refreshBtn.innerText;
        refreshBtn.disabled = true;
        refreshBtn.style.opacity = '0.7';
        const loadingToast = showToast('â³ æ­£åœ¨è¯·æ±‚èŠ‚ç‚¹æ•°æ®.....', 'info', 0); 
        
        fetch("{{ url_for('komari_api_bp.manual_refresh_api') }}", { method: 'POST', headers: {'Content-Type': 'application/json'} })
        .then(r => r.json()).then(d => {
            loadingToast.classList.add('fade-out');
            setTimeout(() => loadingToast.remove(), 400);
            if (d.status === 'success') {
                showToast('âœ… åŒæ­¥æˆåŠŸï¼Œå³å°†åˆ·æ–°...', 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('âŒ ' + d.message, 'error');
                refreshBtn.disabled = false;
                refreshBtn.style.opacity = '1';
            }
        }).catch(e => {
            loadingToast.classList.add('fade-out');
            setTimeout(() => loadingToast.remove(), 400);
            showToast('âŒ è¯·æ±‚é”™è¯¯', 'error');
            refreshBtn.disabled = false;
            refreshBtn.style.opacity = '1';
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        refreshBtn.addEventListener('click', triggerRefresh);
        
        // å¯åŠ¨ Twemoji è§£æ
        if (typeof twemoji !== 'undefined') {
            twemoji.parse(document.body, {
                folder: 'svg',
                ext: '.svg'
            });
        }
    });
</script>
{% endblock %}